# 3.3 Flyway æ•°æ®åº“è¿ç§»

> æœ¬èŠ‚æˆ‘ä»¬å°†ä½¿ç”¨ Flyway ç®¡ç†æ•°æ®åº“ç‰ˆæœ¬ï¼Œè®¾è®¡ MiniClaw çš„æ ¸å¿ƒæ•°æ®è¡¨ã€‚

## ğŸ“‹ æœ¬èŠ‚ç›®æ ‡

- ç†è§£ Flyway æ•°æ®åº“è¿ç§»çš„ä½œç”¨
- è®¾è®¡ Session/Run/Message æ•°æ®è¡¨
- åˆ›å»ºç¬¬ä¸€ä¸ªè¿ç§»è„šæœ¬
- éªŒè¯è¿ç§»æ‰§è¡ŒæˆåŠŸ

## ğŸ¯ æœ¬èŠ‚è¦ç‚¹

**ä¸ºä»€ä¹ˆéœ€è¦ Flywayï¼Ÿ**

æ•°æ®åº“ç»“æ„ä¼šéšç€é¡¹ç›®æ¼”è¿›ä¸æ–­å˜åŒ–ï¼š
- æ–°å¢è¡¨
- ä¿®æ”¹å­—æ®µ
- æ·»åŠ ç´¢å¼•
- æ•°æ®è¿ç§»

**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š**
- âŒ æ‰‹åŠ¨æ‰§è¡Œ SQL è„šæœ¬ï¼ˆå®¹æ˜“é—æ¼ï¼‰
- âŒ å›¢é˜Ÿåä½œæ—¶æ•°æ®åº“ç»“æ„ä¸ä¸€è‡´
- âŒ æ— æ³•è¿½è¸ªå†å²å˜æ›´
- âŒ å›æ»šå›°éš¾

**Flyway çš„è§£å†³æ–¹æ¡ˆï¼š**
- âœ… ç‰ˆæœ¬åŒ–ç®¡ç†æ•°æ®åº“å˜æ›´
- âœ… è‡ªåŠ¨æ‰§è¡Œè¿ç§»è„šæœ¬
- âœ… å›¢é˜Ÿåä½œæ—¶ä¿è¯æ•°æ®åº“ä¸€è‡´
- âœ… å¯è¿½æº¯å†å²å˜æ›´

**æ ¸å¿ƒæ¦‚å¿µï¼š**

1. **è¿ç§»è„šæœ¬ï¼ˆMigrationï¼‰**ï¼šSQL æ–‡ä»¶ï¼Œå®šä¹‰æ•°æ®åº“å˜æ›´
2. **ç‰ˆæœ¬å·ï¼ˆVersionï¼‰**ï¼šæ¯ä¸ªè¿ç§»è„šæœ¬æœ‰å”¯ä¸€ç‰ˆæœ¬å·ï¼ˆå¦‚ V1ã€V2ï¼‰
3. **æ ¡éªŒå’Œï¼ˆChecksumï¼‰**ï¼šFlyway æ£€æµ‹è„šæœ¬æ˜¯å¦è¢«ä¿®æ”¹
4. **æ‰§è¡Œè®°å½•**ï¼šFlyway åœ¨æ•°æ®åº“ä¸­è®°å½•å·²æ‰§è¡Œçš„è„šæœ¬

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

MiniClaw çš„æ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Session   â”‚ ä¸€æ¬¡å®Œæ•´çš„å¯¹è¯ä¼šè¯
â”‚             â”‚
â”‚ id          â”‚â”€â”€â”€â”€â”€â”
â”‚ user_id     â”‚     â”‚
â”‚ title       â”‚     â”‚
â”‚ status      â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                    â”‚ 1:N
                    â”‚
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Run     â”‚ ä¸€æ¬¡ Agent æ‰§è¡Œè¿‡ç¨‹
â”‚             â”‚
â”‚ id          â”‚â”€â”€â”€â”€â”€â”
â”‚ session_id  â”‚     â”‚
â”‚ status      â”‚     â”‚
â”‚ model       â”‚     â”‚
â”‚ tokens_used â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                    â”‚ 1:N
                    â”‚
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Message   â”‚ ä¸€æ¡æ¶ˆæ¯
â”‚             â”‚
â”‚ id          â”‚
â”‚ run_id      â”‚
â”‚ role        â”‚
â”‚ content     â”‚
â”‚ tokens      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³ç³»è¯´æ˜ï¼š**

- **1 ä¸ª Session** åŒ…å« **N ä¸ª Run**ï¼ˆä¸€ä¸ªä¼šè¯å¯èƒ½æœ‰å¤šæ¬¡æ‰§è¡Œï¼‰
- **1 ä¸ª Run** åŒ…å« **N ä¸ª Message**ï¼ˆä¸€æ¬¡æ‰§è¡ŒåŒ…å«å¤šè½®å¯¹è¯ï¼‰
- **çº§è”åˆ é™¤**ï¼šåˆ é™¤ Session æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤å…³è”çš„ Run å’Œ Message

**å­—æ®µè®¾è®¡æ€è·¯ï¼š**

| è¡¨ | å…³é”®å­—æ®µ | è¯´æ˜ |
|----|---------|------|
| Session | `user_id`, `status`, `metadata` | ç”¨æˆ·æ ‡è¯†ã€ä¼šè¯çŠ¶æ€ã€æ‰©å±•å…ƒæ•°æ® |
| Run | `session_id`, `status`, `tokens_used`, `cost_cents` | å…³è”ä¼šè¯ã€æ‰§è¡ŒçŠ¶æ€ã€Token æ¶ˆè€—ã€æˆæœ¬ç»Ÿè®¡ |
| Message | `run_id`, `role`, `content`, `tokens` | å…³è”æ‰§è¡Œã€æ¶ˆæ¯è§’è‰²ã€å†…å®¹ã€Token æ•°é‡ |

## ğŸ“„ è¿ç§»è„šæœ¬è§£æ

### æ–‡ä»¶ç»“æ„

```
miniclaw-learn/
â””â”€â”€ src/main/resources/
    â””â”€â”€ db/
        â””â”€â”€ migration/
            â””â”€â”€ V1__init_schema.sql    # åˆå§‹åŒ–è¡¨ç»“æ„
```

### å‘½åè§„èŒƒ

```
V{ç‰ˆæœ¬å·}__{æè¿°}.sql

ç¤ºä¾‹ï¼š
V1__init_schema.sql          # ç‰ˆæœ¬ 1ï¼Œåˆå§‹åŒ–è¡¨ç»“æ„
V2__add_user_table.sql       # ç‰ˆæœ¬ 2ï¼Œæ·»åŠ ç”¨æˆ·è¡¨
V3__add_indexes.sql          # ç‰ˆæœ¬ 3ï¼Œæ·»åŠ ç´¢å¼•
```

**æ³¨æ„ï¼š**
- ç‰ˆæœ¬å·å¿…é¡»é€’å¢
- åŒä¸‹åˆ’çº¿ `__` åˆ†éš”ç‰ˆæœ¬å·å’Œæè¿°
- æ–‡ä»¶åä¸€æ—¦æäº¤ï¼Œä¸å¯ä¿®æ”¹ï¼ˆFlyway ä¼šæ ¡éªŒ Checksumï¼‰

### V1__init_schema.sql æ ¸å¿ƒå†…å®¹

#### 1. sessions è¡¨

```sql
CREATE TABLE sessions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id VARCHAR(255) NOT NULL,
    title VARCHAR(500),
    status VARCHAR(50) NOT NULL DEFAULT 'active',
    metadata JSONB,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

**å…³é”®å­—æ®µï¼š**
- `id`ï¼šUUID ä¸»é”®ï¼ˆé¿å… ID å†²çªï¼‰
- `user_id`ï¼šç”¨æˆ·æ ‡è¯†
- `status`ï¼šä¼šè¯çŠ¶æ€ï¼ˆactive/archived/deletedï¼‰
- `metadata`ï¼šJSONB ç±»å‹ï¼Œå­˜å‚¨æ‰©å±•å…ƒæ•°æ®

#### 2. runs è¡¨

```sql
CREATE TABLE runs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    model VARCHAR(100),
    tokens_used INTEGER DEFAULT 0,
    cost_cents INTEGER DEFAULT 0,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

**å…³é”®å­—æ®µï¼š**
- `session_id`ï¼šå¤–é”®ï¼Œå…³è” sessions è¡¨
- `status`ï¼šæ‰§è¡ŒçŠ¶æ€ï¼ˆpending/running/completed/failedï¼‰
- `tokens_used`ï¼šToken æ¶ˆè€—ç»Ÿè®¡
- `cost_cents`ï¼šæˆæœ¬ç»Ÿè®¡ï¼ˆå•ä½ï¼šåˆ†ï¼‰

#### 3. messages è¡¨

```sql
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    run_id UUID NOT NULL REFERENCES runs(id) ON DELETE CASCADE,
    role VARCHAR(50) NOT NULL,
    content TEXT NOT NULL,
    tokens INTEGER,
    metadata JSONB,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

**å…³é”®å­—æ®µï¼š**
- `run_id`ï¼šå¤–é”®ï¼Œå…³è” runs è¡¨
- `role`ï¼šæ¶ˆæ¯è§’è‰²ï¼ˆuser/assistant/system/toolï¼‰
- `content`ï¼šæ¶ˆæ¯å†…å®¹
- `tokens`ï¼šæ¶ˆæ¯çš„ Token æ•°é‡

## ğŸš€ æ‰§è¡Œè¿ç§»

### 1. å¯åŠ¨æ•°æ®åº“

ç¡®ä¿ PostgreSQL å·²å¯åŠ¨ï¼š

```bash
cd miniclaw-learn
docker-compose up -d
```

### 2. å¯åŠ¨åº”ç”¨

```bash
mvn spring-boot:run
```

**é¢„æœŸè¾“å‡ºï¼ˆFlyway æ—¥å¿—ï¼‰ï¼š**

```
Flyway Community Edition 9.x.x by Redgate
Database: jdbc:postgresql://localhost:5432/miniclaw (PostgreSQL 16.0)

Successfully validated 1 migration (execution time 00:00.015s)
Creating Schema History table "public"."flyway_schema_history" ...
Current version of schema "public": null
Migrating schema "public" to version "1 - init schema"
Successfully applied 1 migration to schema "public" (execution time 00:00.234s)
```

### 3. éªŒè¯è¿ç§»

è¿æ¥æ•°æ®åº“ï¼š

```bash
psql -h localhost -U miniclaw -d miniclaw
```

æŸ¥çœ‹å·²æ‰§è¡Œçš„è¿ç§»ï¼š

```sql
SELECT * FROM flyway_schema_history;
```

**é¢„æœŸè¾“å‡ºï¼š**

```
installed_rank | version | description    | type     | script                | checksum   | installed_by | installed_on
---------------+---------+----------------+----------+-----------------------+------------+--------------+----------------------------
             1 | 1       | init schema    | SQL      | V1__init_schema.sql   |  123456789 | miniclaw     | 2026-02-16 15:30:00.123456
```

æŸ¥çœ‹è¡¨ç»“æ„ï¼š

```sql
\dt

\dt+ sessions
\dt+ runs
\dt+ messages
```

## âœ… éªŒè¯æ•°æ®è¡¨

### 1. æŸ¥çœ‹è¡¨ç»“æ„

```sql
-- æŸ¥çœ‹ sessions è¡¨
\d sessions

-- æŸ¥çœ‹ runs è¡¨
\d runs

-- æŸ¥çœ‹ messages è¡¨
\d messages
```

### 2. æŸ¥çœ‹ç´¢å¼•

```sql
SELECT
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE schemaname = 'public'
ORDER BY tablename, indexname;
```

### 3. æµ‹è¯•æ’å…¥æ•°æ®

```sql
-- æ’å…¥æµ‹è¯•ä¼šè¯
INSERT INTO sessions (user_id, title, status)
VALUES ('user-123', 'æµ‹è¯•ä¼šè¯', 'active')
RETURNING *;

-- æ’å…¥æµ‹è¯•æ‰§è¡Œ
INSERT INTO runs (session_id, status, model)
VALUES ((SELECT id FROM sessions LIMIT 1), 'running', 'gpt-4')
RETURNING *;

-- æ’å…¥æµ‹è¯•æ¶ˆæ¯
INSERT INTO messages (run_id, role, content, tokens)
VALUES ((SELECT id FROM runs LIMIT 1), 'user', 'ä½ å¥½ï¼ŒAI', 5)
RETURNING *;

-- æ¸…ç†æµ‹è¯•æ•°æ®
DELETE FROM sessions;
```

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

### Flyway Maven æ’ä»¶

```bash
# æŸ¥çœ‹è¿ç§»çŠ¶æ€
mvn flyway:info

# æ‰‹åŠ¨æ‰§è¡Œè¿ç§»
mvn flyway:migrate

# æ¸…ç†æ•°æ®åº“ï¼ˆå±é™©ï¼ï¼‰
mvn flyway:clean

# éªŒè¯è¿ç§»è„šæœ¬
mvn flyway:validate
```

### æŸ¥çœ‹è¿ç§»å†å²

```sql
SELECT
    version,
    description,
    type,
    script,
    installed_on,
    execution_time
FROM flyway_schema_history
ORDER BY installed_rank;
```

## ğŸ› å¸¸è§é—®é¢˜

### 1. è¿ç§»è„šæœ¬æ ¡éªŒå¤±è´¥

**é—®é¢˜ï¼š**

```
Flyway validation error: checksum mismatch
```

**åŸå› ï¼š** å·²æ‰§è¡Œçš„è¿ç§»è„šæœ¬è¢«ä¿®æ”¹ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

- **ä¿®å¤è„šæœ¬**ï¼šåˆ›å»ºæ–°çš„è¿ç§»è„šæœ¬ï¼ˆV2ï¼‰ï¼Œä¸è¦ä¿®æ”¹å·²æ‰§è¡Œçš„è„šæœ¬
- **å¼ºåˆ¶ä¿®å¤**ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰ï¼š`mvn flyway:clean` æ¸…ç†æ•°æ®åº“ï¼Œé‡æ–°è¿ç§»

### 2. ç‰ˆæœ¬å·å†²çª

**é—®é¢˜ï¼š**

```
Found non-empty schema without schema history table
```

**åŸå› ï¼š** æ•°æ®åº“å·²æœ‰æ•°æ®ï¼Œä½†æ²¡æœ‰ Flyway å†å²è¡¨ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

åœ¨ `application.yml` ä¸­é…ç½®ï¼š

```yaml
spring:
  flyway:
    baseline-on-migrate: true  # å…è®¸éç©ºæ•°æ®åº“
```

### 3. è¿ç§»æ‰§è¡Œå¤±è´¥

**é—®é¢˜ï¼š**

```
Migration V1__init_schema.sql failed
```

**è§£å†³æ–¹æ¡ˆï¼š**

1. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
2. ä¿®å¤ SQL è„šæœ¬
3. æ‰‹åŠ¨æ¸…ç†å¤±è´¥çš„è¿ç§»ï¼š

```sql
DELETE FROM flyway_schema_history WHERE success = false;
```

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### ä¸ºä»€ä¹ˆç”¨ UUID è€Œä¸æ˜¯è‡ªå¢ IDï¼Ÿ

1. **åˆ†å¸ƒå¼å‹å¥½**ï¼šUUID ä¸ä¼šå†²çªï¼Œé€‚åˆåˆ†å¸ƒå¼ç³»ç»Ÿ
2. **å®‰å…¨æ€§**ï¼šUUID ä¸å¯é¢„æµ‹ï¼Œé˜²æ­¢ ID æšä¸¾æ”»å‡»
3. **æå‰ç”Ÿæˆ**ï¼šå¯ä»¥åœ¨åº”ç”¨å±‚ç”Ÿæˆ IDï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›

### ä¸ºä»€ä¹ˆç”¨ JSONBï¼Ÿ

1. **çµæ´»æ€§**ï¼šå­˜å‚¨ä¸å®šç»“æ„çš„å…ƒæ•°æ®
2. **æŸ¥è¯¢èƒ½åŠ›**ï¼šPostgreSQL æ”¯æŒ JSONB æŸ¥è¯¢å’Œç´¢å¼•
3. **æ‰©å±•æ€§**ï¼šä¸éœ€è¦é¢‘ç¹ä¿®æ”¹è¡¨ç»“æ„

ç¤ºä¾‹æŸ¥è¯¢ï¼š

```sql
-- æŸ¥è¯¢ metadata ä¸­åŒ…å«ç‰¹å®šå­—æ®µçš„ä¼šè¯
SELECT * FROM sessions
WHERE metadata->>'source' = 'telegram';

-- æŸ¥è¯¢ metadata ä¸­æŸä¸ªå­—æ®µçš„å€¼
SELECT metadata->>'user_name' FROM sessions WHERE id = '...';
```

### ä¸ºä»€ä¹ˆæ·»åŠ è¿™ä¹ˆå¤šç´¢å¼•ï¼Ÿ

ç´¢å¼•åŠ é€ŸæŸ¥è¯¢ï¼Œä½†ä¼šé™ä½å†™å…¥é€Ÿåº¦ã€‚MiniClaw çš„æŸ¥è¯¢æ¨¡å¼ï¼š

- æŒ‰ `user_id` æŸ¥è¯¢ä¼šè¯ï¼ˆé¢‘ç¹ï¼‰
- æŒ‰ `session_id` æŸ¥è¯¢æ‰§è¡Œè®°å½•ï¼ˆé¢‘ç¹ï¼‰
- æŒ‰ `run_id` æŸ¥è¯¢æ¶ˆæ¯ï¼ˆé¢‘ç¹ï¼‰
- æŒ‰æ—¶é—´æ’åºï¼ˆé¢‘ç¹ï¼‰

å› æ­¤æ·»åŠ äº†å¯¹åº”çš„ç´¢å¼•ã€‚

## ğŸ“š æ‰©å±•é˜…è¯»

- [Flyway å®˜æ–¹æ–‡æ¡£](https://flywaydb.org/documentation/)
- [PostgreSQL UUID ç±»å‹](https://www.postgresql.org/docs/current/datatype-uuid.html)
- [PostgreSQL JSONB ç±»å‹](https://www.postgresql.org/docs/current/datatype-json.html)

## ğŸ¯ ä¸‹ä¸€æ­¥

ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†ï¼š
- åˆ›å»º JPA å®ä½“ç±»
- å®Œå–„åˆ†å±‚æ¶æ„
- æ·»åŠ  Repository å±‚

[ä¸‹ä¸€èŠ‚ï¼š3.4 é¡¹ç›®éª¨æ¶ â†’](./3.4-project-skeleton.md)
