# 3.5 é…ç½®ç®¡ç†

> æœ¬èŠ‚æˆ‘ä»¬å°†é…ç½®å¤šç¯å¢ƒç®¡ç†ï¼Œè®© MiniClaw åœ¨ä¸åŒç¯å¢ƒä¸­ä½¿ç”¨ä¸åŒçš„é…ç½®ã€‚

## ğŸ“‹ æœ¬èŠ‚ç›®æ ‡

- ç†è§£ Spring Boot é…ç½®ä½“ç³»
- åˆ›å»º dev/test/prod å¤šç¯å¢ƒé…ç½®
- å­¦ä¼šä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯
- ä¼˜åŒ–è¿æ¥æ± å’Œæ—¥å¿—é…ç½®

## ğŸ¯ æœ¬èŠ‚è¦ç‚¹

**ä¸ºä»€ä¹ˆéœ€è¦å¤šç¯å¢ƒé…ç½®ï¼Ÿ**

ä¸åŒç¯å¢ƒæœ‰ä¸åŒçš„é…ç½®éœ€æ±‚ï¼š

| ç¯å¢ƒ | æ•°æ®åº“ | æ—¥å¿—çº§åˆ« | è°ƒè¯•æ¨¡å¼ |
|------|--------|----------|----------|
| **å¼€å‘** | localhost | DEBUG | âœ… å¼€å¯ |
| **æµ‹è¯•** | æµ‹è¯•æœåŠ¡å™¨ | INFO | âŒ å…³é—­ |
| **ç”Ÿäº§** | ç”Ÿäº§æœåŠ¡å™¨ | WARN | âŒ å…³é—­ |

**å¤šç¯å¢ƒé…ç½®çš„å¥½å¤„ï¼š**

1. **ä»£ç ç»Ÿä¸€**ï¼šåŒä¸€ä»½ä»£ç ï¼Œä¸åŒé…ç½®
2. **å®‰å…¨éš”ç¦»**ï¼šæ•æ„Ÿä¿¡æ¯ä¸ä¼šæ³„éœ²åˆ°å¼€å‘ç¯å¢ƒ
3. **å¿«é€Ÿåˆ‡æ¢**ï¼š`-Dspring.profiles.active=prod` ä¸€é”®åˆ‡æ¢

**æœ¬èŠ‚å®Œæˆåï¼Œä½ ä¼šå¾—åˆ°ï¼š**

- âœ… å®Œæ•´çš„å¤šç¯å¢ƒé…ç½®æ–‡ä»¶
- âœ… ç¯å¢ƒå˜é‡æ³¨å…¥æœºåˆ¶
- âœ… æ•æ„Ÿä¿¡æ¯ä¿æŠ¤æ–¹æ¡ˆ
- âœ… è¿æ¥æ± ä¼˜åŒ–é…ç½®

## ğŸ“¦ é…ç½®æ–‡ä»¶ç»“æ„

```
miniclaw-learn/
â””â”€â”€ src/main/resources/
    â”œâ”€â”€ application.yml              # ä¸»é…ç½®ï¼ˆé€šç”¨é…ç½®ï¼‰
    â”œâ”€â”€ application-dev.yml          # å¼€å‘ç¯å¢ƒé…ç½®
    â”œâ”€â”€ application-test.yml         # æµ‹è¯•ç¯å¢ƒé…ç½®
    â”œâ”€â”€ application-prod.yml         # ç”Ÿäº§ç¯å¢ƒé…ç½®
    â””â”€â”€ application-secret.yml.example  # æ•æ„Ÿä¿¡æ¯ç¤ºä¾‹
```

## ğŸ“„ é…ç½®æ–‡ä»¶è§£æ

### 1. application.ymlï¼ˆä¸»é…ç½®ï¼‰

```yaml
spring:
  application:
    name: miniclaw-learn

  # æ¿€æ´»çš„é…ç½®æ–‡ä»¶ï¼ˆé»˜è®¤ devï¼‰
  profiles:
    active: dev

  # JPA é…ç½®
  jpa:
    hibernate:
      ddl-auto: none  # ç¦ç”¨è‡ªåŠ¨å»ºè¡¨
    show-sql: false

  # Flyway é…ç½®
  flyway:
    enabled: true
    baseline-on-migrate: true

# æœåŠ¡å™¨é…ç½®
server:
  port: 8080
  shutdown: graceful  # ä¼˜é›…å…³é—­

# æ—¥å¿—é…ç½®
logging:
  level:
    root: INFO
    com.miniclaw: DEBUG
```

**å…³é”®é…ç½®ï¼š**

| é…ç½® | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `profiles.active` | æ¿€æ´»çš„é…ç½®æ–‡ä»¶ | `dev` |
| `ddl-auto` | Hibernate è‡ªåŠ¨å»ºè¡¨ | `none`ï¼ˆä½¿ç”¨ Flywayï¼‰ |
| `shutdown` | å…³é—­æ–¹å¼ | `graceful`ï¼ˆä¼˜é›…å…³é—­ï¼‰ |

### 2. application-dev.ymlï¼ˆå¼€å‘ç¯å¢ƒï¼‰

```yaml
spring:
  config:
    activate:
      on-profile: dev

  # å¼€å‘ç¯å¢ƒæ•°æ®æº
  datasource:
    url: jdbc:postgresql://localhost:5432/miniclaw
    username: miniclaw
    password: miniclaw123
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5

# å¼€å‘ç¯å¢ƒæ—¥å¿—ï¼ˆè¯¦ç»†ï¼‰
logging:
  level:
    com.miniclaw: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE

miniclaw:
  debug: true
  show-sql: true
```

**ç‰¹ç‚¹ï¼š**
- âœ… è¿æ¥æœ¬åœ°æ•°æ®åº“
- âœ… è¯¦ç»†çš„ SQL æ—¥å¿—
- âœ… å¼€å¯è°ƒè¯•æ¨¡å¼

### 3. application-test.ymlï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰

```yaml
spring:
  config:
    activate:
      on-profile: test

  # æµ‹è¯•ç¯å¢ƒæ•°æ®æºï¼ˆç¯å¢ƒå˜é‡ï¼‰
  datasource:
    url: ${DATABASE_URL:jdbc:postgresql://localhost:5432/miniclaw_test}
    username: ${DATABASE_USER:miniclaw}
    password: ${DATABASE_PASSWORD:miniclaw123}

# æµ‹è¯•ç¯å¢ƒæ—¥å¿—ï¼ˆç®€æ´ï¼‰
logging:
  level:
    com.miniclaw: INFO
    org.hibernate.SQL: INFO

miniclaw:
  debug: false
  show-sql: false
```

**ç‰¹ç‚¹ï¼š**
- âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰
- âœ… é€‚ä¸­çš„æ—¥å¿—çº§åˆ«
- âœ… å…³é—­è°ƒè¯•æ¨¡å¼

**ç¯å¢ƒå˜é‡è¯­æ³•ï¼š**

```yaml
${ç¯å¢ƒå˜é‡å:é»˜è®¤å€¼}

ç¤ºä¾‹ï¼š
${DATABASE_URL:jdbc:postgresql://localhost:5432/miniclaw}
# å¦‚æœ DATABASE_URL å­˜åœ¨ï¼Œä½¿ç”¨å®ƒçš„å€¼
# å¦åˆ™ä½¿ç”¨é»˜è®¤å€¼ jdbc:postgresql://localhost:5432/miniclaw
```

### 4. application-prod.ymlï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

```yaml
spring:
  config:
    activate:
      on-profile: prod

  # ç”Ÿäº§ç¯å¢ƒæ•°æ®æºï¼ˆå¿…é¡»ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼‰
  datasource:
    url: ${DATABASE_URL}
    username: ${DATABASE_USER}
    password: ${DATABASE_PASSWORD}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 10
      leak-detection-threshold: 60000  # è¿æ¥æ³„éœ²æ£€æµ‹

# ç”Ÿäº§ç¯å¢ƒæ—¥å¿—ï¼ˆç®€æ´ï¼‰
logging:
  level:
    root: WARN
    com.miniclaw: INFO
    org.hibernate.SQL: WARN

miniclaw:
  debug: false
  show-sql: false

server:
  shutdown: graceful

spring.lifecycle.timeout-per-shutdown-phase: 30s
```

**ç‰¹ç‚¹ï¼š**
- âœ… å¼ºåˆ¶ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆæ— é»˜è®¤å€¼ï¼‰
- âœ… ä¼˜åŒ–çš„è¿æ¥æ± 
- âœ… è¿æ¥æ³„éœ²æ£€æµ‹
- âœ… ä¼˜é›…å…³é—­ï¼ˆ30 ç§’è¶…æ—¶ï¼‰

## ğŸ” æ•æ„Ÿä¿¡æ¯ç®¡ç†

### æ–¹æ¡ˆ 1ï¼šç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰

**è®¾ç½®ç¯å¢ƒå˜é‡ï¼š**

```bash
# Linux/macOS
export DATABASE_URL="jdbc:postgresql://prod-server:5432/miniclaw"
export DATABASE_USER="prod_user"
export DATABASE_PASSWORD="strong_password"

# å¯åŠ¨åº”ç”¨
java -jar miniclaw-learn.jar
```

**Docker Composeï¼š**

```yaml
services:
  app:
    image: miniclaw-learn
    environment:
      - DATABASE_URL=jdbc:postgresql://postgres:5432/miniclaw
      - DATABASE_USER=miniclaw
      - DATABASE_PASSWORD=strong_password
```

### æ–¹æ¡ˆ 2ï¼šé…ç½®æ–‡ä»¶ï¼ˆä¸æ¨èï¼‰

åˆ›å»º `application-secret.yml`ï¼ˆä¸æäº¤åˆ° Gitï¼‰ï¼š

```yaml
spring:
  datasource:
    url: jdbc:postgresql://prod-server:5432/miniclaw
    username: prod_user
    password: strong_password
```

**.gitignore å·²é…ç½®ï¼š**

```gitignore
application-secret.yml
*-secret.yml
*-local.yml
```

## ğŸš€ ç¯å¢ƒåˆ‡æ¢

### 1. å‘½ä»¤è¡Œå‚æ•°

```bash
# å¼€å‘ç¯å¢ƒï¼ˆé»˜è®¤ï¼‰
mvn spring-boot:run

# æµ‹è¯•ç¯å¢ƒ
mvn spring-boot:run -Dspring.profiles.active=test

# ç”Ÿäº§ç¯å¢ƒ
java -jar miniclaw-learn.jar --spring.profiles.active=prod
```

### 2. ç¯å¢ƒå˜é‡

```bash
export SPRING_PROFILES_ACTIVE=prod
java -jar miniclaw-learn.jar
```

### 3. IDE é…ç½®

**IDEAï¼š**

1. `Run` â†’ `Edit Configurations`
2. `Environment variables`: `SPRING_PROFILES_ACTIVE=prod`
3. æˆ– `VM options`: `-Dspring.profiles.active=prod`

## âœ… éªŒè¯é…ç½®

### 1. æŸ¥çœ‹æ¿€æ´»çš„é…ç½®æ–‡ä»¶

```bash
curl http://localhost:8080/actuator/env | jq '.propertySources[] | select(.name | contains("application"))'
```

### 2. æŸ¥çœ‹å…·ä½“é…ç½®é¡¹

```bash
# æŸ¥çœ‹æ•°æ®æºé…ç½®
curl http://localhost:8080/actuator/env/spring.datasource.url

# æŸ¥çœ‹æ¿€æ´»çš„ profile
curl http://localhost:8080/actuator/env/spring.profiles.active
```

### 3. æ—¥å¿—éªŒè¯

**å¼€å‘ç¯å¢ƒæ—¥å¿—ï¼š**

```
2026-02-16 16:30:00.123 DEBUG 12345 --- [nio-8080-exec-1] com.miniclaw.controller.HealthController : Processing health check
2026-02-16 16:30:00.124 DEBUG 12345 --- [nio-8080-exec-1] org.hibernate.SQL : select s1_0.id,s1_0.title from sessions s1_0
```

**ç”Ÿäº§ç¯å¢ƒæ—¥å¿—ï¼š**

```
2026-02-16 16:30:00.123 INFO 12345 --- [nio-8080-exec-1] com.miniclaw.controller.HealthController : Health check completed
```

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### é…ç½®ä¼˜å…ˆçº§

Spring Boot é…ç½®åŠ è½½é¡ºåºï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š

```
1. å‘½ä»¤è¡Œå‚æ•°
2. ç¯å¢ƒå˜é‡
3. application-{profile}.yml
4. application.yml
```

**ç¤ºä¾‹ï¼š**

```bash
# æœ€é«˜ä¼˜å…ˆçº§ï¼šå‘½ä»¤è¡Œå‚æ•°
java -jar app.jar --server.port=9090

# æ¬¡é«˜ä¼˜å…ˆçº§ï¼šç¯å¢ƒå˜é‡
export SERVER_PORT=9090

# è¾ƒä½ä¼˜å…ˆçº§ï¼šapplication-prod.yml
server:
  port: 9090

# æœ€ä½ä¼˜å…ˆçº§ï¼šapplication.yml
server:
  port: 8080  # ä¼šè¢«è¦†ç›–
```

### HikariCP è¿æ¥æ± 

**å…³é”®é…ç½®ï¼š**

| é…ç½® | è¯´æ˜ | ç”Ÿäº§å»ºè®® |
|------|------|----------|
| `maximum-pool-size` | æœ€å¤§è¿æ¥æ•° | CPU æ ¸å¿ƒæ•° * 2 + 1 |
| `minimum-idle` | æœ€å°ç©ºé—²è¿æ¥ | ä¸ maximum ç›¸åŒ |
| `connection-timeout` | è¿æ¥è¶…æ—¶ï¼ˆmsï¼‰ | 30000 |
| `idle-timeout` | ç©ºé—²è¶…æ—¶ï¼ˆmsï¼‰ | 600000 |
| `max-lifetime` | æœ€å¤§ç”Ÿå‘½å‘¨æœŸï¼ˆmsï¼‰ | 1800000 |
| `leak-detection-threshold` | æ³„éœ²æ£€æµ‹ï¼ˆmsï¼‰ | 60000 |

**æ³„éœ²æ£€æµ‹ï¼š**

å¦‚æœä¸€ä¸ªè¿æ¥è¢«ç§Ÿç”¨è¶…è¿‡ 60 ç§’æ²¡æœ‰å½’è¿˜ï¼ŒHikariCP ä¼šè®°å½•è­¦å‘Šæ—¥å¿—ã€‚

### ä¼˜é›…å…³é—­

```yaml
server:
  shutdown: graceful

spring.lifecycle.timeout-per-shutdown-phase: 30s
```

**å·¥ä½œåŸç†ï¼š**

1. æ”¶åˆ° SIGTERM ä¿¡å·
2. åœæ­¢æ¥æ”¶æ–°è¯·æ±‚
3. ç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆï¼ˆæœ€å¤š 30 ç§’ï¼‰
4. å¼ºåˆ¶å…³é—­

## ğŸ› å¸¸è§é—®é¢˜

### 1. é…ç½®ä¸ç”Ÿæ•ˆ

**é—®é¢˜ï¼š** ä¿®æ”¹äº†é…ç½®æ–‡ä»¶ï¼Œä½†åº”ç”¨æ²¡æœ‰ä½¿ç”¨æ–°é…ç½®ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

1. ç¡®è®¤é…ç½®æ–‡ä»¶åç§°æ­£ç¡®
2. ç¡®è®¤ `spring.profiles.active` è®¾ç½®æ­£ç¡®
3. é‡å¯åº”ç”¨

```bash
# æŸ¥çœ‹æ¿€æ´»çš„ profile
curl http://localhost:8080/actuator/env/spring.profiles.active
```

### 2. ç¯å¢ƒå˜é‡ä¸ç”Ÿæ•ˆ

**é—®é¢˜ï¼š** è®¾ç½®äº†ç¯å¢ƒå˜é‡ï¼Œä½†åº”ç”¨è¯»å–ä¸åˆ°ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

æ£€æŸ¥ç¯å¢ƒå˜é‡åç§°æ˜¯å¦æ­£ç¡®ï¼š

```bash
# Spring Boot ä¼šå°†ç‚¹å·è½¬ä¸ºä¸‹åˆ’çº¿
spring.datasource.url â†’ SPRING_DATASOURCE_URL

# æ­£ç¡®çš„ç¯å¢ƒå˜é‡
export SPRING_DATASOURCE_URL="jdbc:postgresql://..."
export SPRING_DATASOURCE_USERNAME="miniclaw"
export SPRING_DATASOURCE_PASSWORD="password"
```

### 3. æ•æ„Ÿä¿¡æ¯æ³„éœ²

**é—®é¢˜ï¼š** ä¸å°å¿ƒå°†å¯†ç æäº¤åˆ° Gitã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

1. ç«‹å³ä¿®æ”¹å¯†ç 
2. æ·»åŠ åˆ° `.gitignore`
3. ä½¿ç”¨ `git filter-branch` åˆ é™¤å†å²è®°å½•ï¼ˆå±é™©æ“ä½œï¼‰

**é¢„é˜²æªæ–½ï¼š**
- âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡
- âœ… å®šæœŸæ£€æŸ¥ `.gitignore`
- âœ… ä»£ç å®¡æŸ¥æ—¶æ£€æŸ¥æ•æ„Ÿä¿¡æ¯

## ğŸ“š æ‰©å±•é˜…è¯»

- [Spring Boot é…ç½®å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config)
- [HikariCP é…ç½®ä¼˜åŒ–](https://github.com/brettwooldridge/HikariCP/wiki)
- [ç¯å¢ƒå˜é‡æœ€ä½³å®è·µ](https://12factor.net/config)

## ğŸ‰ ç¬¬ä¸‰ç« æ€»ç»“

æ­å–œï¼ç¬¬ä¸‰ç« å·²å…¨éƒ¨å®Œæˆã€‚æˆ‘ä»¬å­¦ä¹ äº†ï¼š

1. **å¼€å‘ç¯å¢ƒå‡†å¤‡** - JDKã€Mavenã€Spring Boot é¡¹ç›®
2. **Docker Compose** - PostgreSQL + pgvector ç¼–æ’
3. **Flyway è¿ç§»** - æ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶
4. **é¡¹ç›®éª¨æ¶** - åˆ†å±‚æ¶æ„ã€JPA å®ä½“ã€Repository
5. **é…ç½®ç®¡ç†** - å¤šç¯å¢ƒé…ç½®ã€æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

**æœ€ç»ˆé¡¹ç›®ç»“æ„ï¼š**

```
miniclaw-learn/
â”œâ”€â”€ pom.xml
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ src/main/
â”‚   â”œâ”€â”€ java/com/miniclaw/
â”‚   â”‚   â”œâ”€â”€ MiniClawApplication.java
â”‚   â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â””â”€â”€ repository/
â”‚   â””â”€â”€ resources/
â”‚       â”œâ”€â”€ application.yml
â”‚       â”œâ”€â”€ application-dev.yml
â”‚       â”œâ”€â”€ application-test.yml
â”‚       â”œâ”€â”€ application-prod.yml
â”‚       â””â”€â”€ db/migration/
â””â”€â”€ src/test/
```

## ğŸ¯ ä¸‹ä¸€ç« é¢„å‘Š

ç¬¬å››ç« æˆ‘ä»¬å°†å­¦ä¹ ï¼š

- LLM å®¢æˆ·ç«¯è®¾è®¡
- OpenAI å…¼å®¹ API
- SSE æµå¼è¾“å‡º
- Reactor Flux å“åº”å¼ç¼–ç¨‹

[ä¸‹ä¸€ç« ï¼šLLM å¯¹æ¥ä¸æµå¼è¾“å‡º â†’](../chapter-04/)
