# 3.4 é¡¹ç›®éª¨æ¶

> æœ¬èŠ‚æˆ‘ä»¬å°†å®Œå–„ MiniClaw çš„é¡¹ç›®éª¨æ¶ï¼Œå»ºç«‹æ¸…æ™°çš„åˆ†å±‚æ¶æ„ã€‚

## ğŸ“‹ æœ¬èŠ‚ç›®æ ‡

- ç†è§£åˆ†å±‚æ¶æ„è®¾è®¡
- åˆ›å»º Session/Run/Message å®ä½“ç±»
- åˆ›å»º Repository æ•°æ®è®¿é—®å±‚
- æ·»åŠ å¥åº·æ£€æŸ¥æ¥å£

## ğŸ¯ æœ¬èŠ‚è¦ç‚¹

**ä¸ºä»€ä¹ˆéœ€è¦åˆ†å±‚æ¶æ„ï¼Ÿ**

éšç€é¡¹ç›®å¤æ‚åº¦å¢åŠ ï¼Œä»£ç ä¼šå˜å¾—éš¾ä»¥ç»´æŠ¤ã€‚åˆ†å±‚æ¶æ„é€šè¿‡èŒè´£åˆ†ç¦»ï¼Œè®©ä»£ç æ›´æ¸…æ™°ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Controller å±‚ï¼ˆæ¥å£å±‚ï¼‰          â”‚  å¤„ç† HTTP è¯·æ±‚
â”‚  - å‚æ•°æ ¡éªŒ                      â”‚
â”‚  - è°ƒç”¨ Service                  â”‚
â”‚  - è¿”å›å“åº”                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service å±‚ï¼ˆä¸šåŠ¡å±‚ï¼‰             â”‚  ä¸šåŠ¡é€»è¾‘å¤„ç†
â”‚  - ä¸šåŠ¡è§„åˆ™                      â”‚
â”‚  - äº‹åŠ¡ç®¡ç†                      â”‚
â”‚  - è°ƒç”¨ Repository               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Repository å±‚ï¼ˆæ•°æ®è®¿é—®å±‚ï¼‰      â”‚  æ•°æ®åº“æ“ä½œ
â”‚  - CRUD æ“ä½œ                    â”‚
â”‚  - æŸ¥è¯¢æ–¹æ³•                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Entity å±‚ï¼ˆå®ä½“å±‚ï¼‰              â”‚  æ•°æ®æ¨¡å‹
â”‚  - æ•°æ®åº“è¡¨æ˜ å°„                  â”‚
â”‚  - å­—æ®µå®šä¹‰                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å„å±‚èŒè´£ï¼š**

| å±‚ | èŒè´£ | ç¤ºä¾‹ |
|----|------|------|
| **Controller** | æ¥æ”¶ HTTP è¯·æ±‚ï¼Œå‚æ•°æ ¡éªŒï¼Œè¿”å›å“åº” | `HealthController` |
| **Service** | ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œäº‹åŠ¡ç®¡ç† | `SessionService`ï¼ˆç¬¬ 5 ç« å®ç°ï¼‰ |
| **Repository** | æ•°æ®åº“ CRUD æ“ä½œ | `SessionRepository` |
| **Entity** | æ•°æ®åº“è¡¨æ˜ å°„ | `Session`ã€`Run`ã€`Message` |

**æœ¬èŠ‚å®Œæˆåï¼Œä½ ä¼šå¾—åˆ°ï¼š**

- âœ… æ¸…æ™°çš„åˆ†å±‚æ¶æ„
- âœ… å®Œæ•´çš„ JPA å®ä½“ç±»
- âœ… å¯ç”¨çš„ Repository æ¥å£
- âœ… å¥åº·æ£€æŸ¥æ¥å£ï¼ˆéªŒè¯é¡¹ç›®èƒ½è¿è¡Œï¼‰

## ğŸ“¦ é¡¹ç›®ç»“æ„

æœ¬èŠ‚å®Œæˆåçš„é¡¹ç›®ç»“æ„ï¼š

```
miniclaw-learn/
â””â”€â”€ src/main/java/com/miniclaw/
    â”œâ”€â”€ MiniClawApplication.java      # ä¸»å¯åŠ¨ç±»
    â”œâ”€â”€ controller/                    # æ§åˆ¶å™¨å±‚
    â”‚   â””â”€â”€ HealthController.java
    â”œâ”€â”€ entity/                        # å®ä½“ç±»
    â”‚   â”œâ”€â”€ Session.java
    â”‚   â”œâ”€â”€ Run.java
    â”‚   â””â”€â”€ Message.java
    â””â”€â”€ repository/                    # æ•°æ®è®¿é—®å±‚
        â”œâ”€â”€ SessionRepository.java
        â”œâ”€â”€ RunRepository.java
        â””â”€â”€ MessageRepository.java
```

## ğŸ“„ å®ä½“ç±»è§£æ

### Session å®ä½“

```java
@Entity
@Table(name = "sessions")
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Session {

    @Id
    @GeneratedValue(generator = "UUID")
    private UUID id;

    @Column(nullable = false)
    private String userId;

    @Column(length = 500)
    private String title;

    @Column(nullable = false, length = 50)
    @Builder.Default
    private String status = "active";

    @Column(columnDefinition = "jsonb")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Map<String, Object> metadata = new HashMap<>();

    @Column(nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
        updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        updatedAt = LocalDateTime.now();
    }
}
```

**å…³é”®æ³¨è§£ï¼š**

| æ³¨è§£ | è¯´æ˜ | ä½œç”¨ |
|------|------|------|
| `@Entity` | æ ‡è®°ä¸º JPA å®ä½“ | æ˜ å°„åˆ°æ•°æ®åº“è¡¨ |
| `@Table(name = "sessions")` | æŒ‡å®šè¡¨å | å¯¹åº” `sessions` è¡¨ |
| `@Id` | æ ‡è®°ä¸»é”® | å”¯ä¸€æ ‡è¯† |
| `@GeneratedValue(generator = "UUID")` | UUID è‡ªåŠ¨ç”Ÿæˆ | æ•°æ®åº“ç”Ÿæˆ UUID |
| `@Builder.Default` | Builder æ¨¡å¼é»˜è®¤å€¼ | æä¾›é»˜è®¤å€¼ |
| `@JdbcTypeCode(SqlTypes.JSON)` | JSON ç±»å‹å¤„ç† | å¤„ç† JSONB å­—æ®µ |
| `@PrePersist` | æŒä¹…åŒ–å‰å›è°ƒ | è‡ªåŠ¨è®¾ç½®æ—¶é—´æˆ³ |
| `@PreUpdate` | æ›´æ–°å‰å›è°ƒ | è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³ |

### Run å®ä½“

ä¸ Session ç±»ä¼¼ï¼Œä½†åŒ…å«æ‰§è¡Œç›¸å…³çš„å­—æ®µï¼š

- `sessionId`ï¼šå…³è”çš„ä¼šè¯ ID
- `status`ï¼šæ‰§è¡ŒçŠ¶æ€ï¼ˆpending/running/completed/failedï¼‰
- `model`ï¼šä½¿ç”¨çš„æ¨¡å‹
- `tokensUsed`ï¼šToken æ¶ˆè€—
- `costCents`ï¼šæ‰§è¡Œæˆæœ¬

### Message å®ä½“

æ¶ˆæ¯å®ä½“ï¼ŒåŒ…å«ï¼š

- `runId`ï¼šå…³è”çš„æ‰§è¡Œè®°å½• ID
- `role`ï¼šæ¶ˆæ¯è§’è‰²ï¼ˆuser/assistant/system/toolï¼‰
- `content`ï¼šæ¶ˆæ¯å†…å®¹
- `tokens`ï¼šToken æ•°é‡
- `metadata`ï¼šæ‰©å±•å…ƒæ•°æ®

## ğŸ—‚ï¸ Repository å±‚

### SessionRepository

```java
@Repository
public interface SessionRepository extends JpaRepository<Session, UUID> {

    // æŒ‰ç”¨æˆ·æŸ¥è¯¢æ‰€æœ‰ä¼šè¯ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´å€’åºï¼‰
    List<Session> findByUserIdOrderByCreatedAtDesc(String userId);

    // æŒ‰çŠ¶æ€æŸ¥è¯¢ä¼šè¯
    List<Session> findByStatusOrderByCreatedAtDesc(String status);

    // æŒ‰ç”¨æˆ·å’ŒçŠ¶æ€æŸ¥è¯¢ä¼šè¯
    List<Session> findByUserIdAndStatusOrderByCreatedAtDesc(String userId, String status);
}
```

**Spring Data JPA æŸ¥è¯¢æ–¹æ³•å‘½åè§„åˆ™ï¼š**

```
findBy + å±æ€§å + æŸ¥è¯¢æ¡ä»¶ + æ’åº

ç¤ºä¾‹ï¼š
findByUserId              â†’ WHERE user_id = ?
findByStatus              â†’ WHERE status = ?
findByUserIdAndStatus     â†’ WHERE user_id = ? AND status = ?
findByUserIdOrderByCreatedAtDesc â†’ WHERE user_id = ? ORDER BY created_at DESC
```

### ä¸ºä»€ä¹ˆç”¨ JpaRepositoryï¼Ÿ

`JpaRepository<Session, UUID>` æä¾›äº†ï¼š

- âœ… `save()`ï¼šä¿å­˜/æ›´æ–°å®ä½“
- âœ… `findById()`ï¼šæŒ‰ ID æŸ¥è¯¢
- âœ… `findAll()`ï¼šæŸ¥è¯¢æ‰€æœ‰
- âœ… `deleteById()`ï¼šæŒ‰ ID åˆ é™¤
- âœ… `count()`ï¼šç»Ÿè®¡æ•°é‡

æ— éœ€å†™ SQLï¼ŒSpring Data JPA è‡ªåŠ¨ç”Ÿæˆã€‚

## ğŸ” å¥åº·æ£€æŸ¥æ¥å£

```java
@RestController
@RequestMapping("/api/health")
public class HealthController {

    @GetMapping
    public Map<String, Object> health() {
        Map<String, Object> response = new HashMap<>();
        response.put("status", "UP");
        response.put("application", "MiniClaw Learn");
        response.put("version", "0.0.1-SNAPSHOT");
        return response;
    }
}
```

**ä½œç”¨ï¼š**
- éªŒè¯é¡¹ç›®èƒ½æ­£å¸¸å¯åŠ¨
- éªŒè¯ Web å±‚é…ç½®æ­£ç¡®
- ç”¨äºè´Ÿè½½å‡è¡¡å™¨å¥åº·æ£€æŸ¥

## âœ… éªŒè¯é¡¹ç›®

### 1. ç¼–è¯‘é¡¹ç›®

```bash
cd miniclaw-learn
mvn clean compile
```

**é¢„æœŸè¾“å‡ºï¼š**

```
[INFO] BUILD SUCCESS
```

### 2. å¯åŠ¨åº”ç”¨

ç¡®ä¿æ•°æ®åº“å·²å¯åŠ¨ï¼š

```bash
docker-compose up -d
```

å¯åŠ¨åº”ç”¨ï¼š

```bash
mvn spring-boot:run
```

**é¢„æœŸè¾“å‡ºï¼š**

```
Started MiniClawApplication in 2.345 seconds
```

### 3. æµ‹è¯•å¥åº·æ£€æŸ¥

```bash
curl http://localhost:8080/api/health
```

**é¢„æœŸå“åº”ï¼š**

```json
{
  "status": "UP",
  "application": "MiniClaw Learn",
  "version": "0.0.1-SNAPSHOT"
}
```

### 4. éªŒè¯æ•°æ®åº“è¿æ¥

åº”ç”¨å¯åŠ¨åï¼ŒFlyway ä¼šè‡ªåŠ¨æ‰§è¡Œè¿ç§»ï¼ˆ3.3 èŠ‚å·²é…ç½®ï¼‰ã€‚

è¿æ¥æ•°æ®åº“éªŒè¯è¡¨æ˜¯å¦åˆ›å»ºï¼š

```bash
psql -h localhost -U miniclaw -d miniclaw
```

```sql
-- æŸ¥çœ‹æ‰€æœ‰è¡¨
\dt

-- æŸ¥çœ‹ sessions è¡¨ç»“æ„
\d sessions

-- æŸ¥çœ‹ Flyway è¿ç§»å†å²
SELECT * FROM flyway_schema_history;
```

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### ä¸ºä»€ä¹ˆç”¨ Lombokï¼Ÿ

Lombok é€šè¿‡æ³¨è§£è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼š

| æ³¨è§£ | ç”Ÿæˆçš„ä»£ç  |
|------|-----------|
| `@Data` | getterã€setterã€toStringã€equalsã€hashCode |
| `@NoArgsConstructor` | æ— å‚æ„é€ å™¨ |
| `@AllArgsConstructor` | å…¨å‚æ„é€ å™¨ |
| `@Builder` | Builder æ¨¡å¼ |

**ç¤ºä¾‹ï¼š**

```java
// ä½¿ç”¨ Lombok
@Data
@Builder
public class Session {
    private UUID id;
    private String userId;
}

// ç­‰ä»·äºï¼ˆä¸ä½¿ç”¨ Lombokï¼‰
public class Session {
    private UUID id;
    private String userId;

    public UUID getId() { return id; }
    public void setId(UUID id) { this.id = id; }
    public String getUserId() { return userId; }
    public void setUserId(String userId) { this.userId = userId; }

    public static SessionBuilder builder() { ... }
    // ... æ›´å¤šæ–¹æ³•
}
```

### @PrePersist å’Œ @PreUpdate

JPA ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼š

- `@PrePersist`ï¼šæŒä¹…åŒ–å‰è°ƒç”¨ï¼ˆINSERT å‰ï¼‰
- `@PreUpdate`ï¼šæ›´æ–°å‰è°ƒç”¨ï¼ˆUPDATE å‰ï¼‰

**ä½œç”¨ï¼š** è‡ªåŠ¨è®¾ç½®æ—¶é—´æˆ³ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤ã€‚

### JSONB å­—æ®µå¤„ç†

PostgreSQL çš„ JSONB ç±»å‹ç”¨äºå­˜å‚¨ JSON æ•°æ®ï¼š

```java
@Column(columnDefinition = "jsonb")
@JdbcTypeCode(SqlTypes.JSON)
private Map<String, Object> metadata;
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```java
Session session = Session.builder()
    .userId("user-123")
    .metadata(Map.of(
        "source", "telegram",
        "user_name", "å¼ ä¸‰"
    ))
    .build();
```

**æŸ¥è¯¢ç¤ºä¾‹ï¼ˆSQLï¼‰ï¼š**

```sql
-- æŸ¥è¯¢ metadata ä¸­ source = 'telegram' çš„ä¼šè¯
SELECT * FROM sessions
WHERE metadata->>'source' = 'telegram';
```

## ğŸ› å¸¸è§é—®é¢˜

### 1. æ‰¾ä¸åˆ° bean

**é—®é¢˜ï¼š**

```
NoSuchBeanDefinitionException: No qualifying bean of type 'SessionRepository'
```

**è§£å†³æ–¹æ¡ˆï¼š**

ç¡®ä¿ Repository æ¥å£æ·»åŠ äº† `@Repository` æ³¨è§£ã€‚

### 2. å®ä½“ç±»æ˜ å°„å¤±è´¥

**é—®é¢˜ï¼š**

```
could not execute statement [ERROR: relation "sessions" does not exist]
```

**è§£å†³æ–¹æ¡ˆï¼š**

1. ç¡®è®¤ Flyway å·²æ‰§è¡Œè¿ç§»ï¼ˆ3.3 èŠ‚ï¼‰
2. æ£€æŸ¥è¡¨åæ˜¯å¦ä¸ `@Table(name = "sessions")` ä¸€è‡´

### 3. JSONB å­—æ®µæ— æ³•ä¿å­˜

**é—®é¢˜ï¼š**

```
ERROR: column "metadata" is of type jsonb but expression is of type bytea
```

**è§£å†³æ–¹æ¡ˆï¼š**

ç¡®ä¿æ·»åŠ äº† `@JdbcTypeCode(SqlTypes.JSON)` æ³¨è§£ã€‚

## ğŸ“š æ‰©å±•é˜…è¯»

- [Spring Data JPA å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/)
- [Lombok å®˜æ–¹æ–‡æ¡£](https://projectlombok.org/)
- [JPA ç”Ÿå‘½å‘¨æœŸå›è°ƒ](https://www.baeldung.com/jpa-entity-lifecycle-events)

## ğŸ¯ ä¸‹ä¸€æ­¥

ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†ï¼š
- é…ç½®å¤šç¯å¢ƒï¼ˆdev/test/prodï¼‰
- ç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼ˆç¯å¢ƒå˜é‡ï¼‰
- ä¼˜åŒ–é…ç½®æ–‡ä»¶ç»“æ„

[ä¸‹ä¸€èŠ‚ï¼š3.5 é…ç½®ç®¡ç† â†’](./3.5-config-management.md)
