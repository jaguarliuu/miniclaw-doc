# 3.2 Docker Compose ç¼–æ’åŸºç¡€è®¾æ–½

> æœ¬èŠ‚æˆ‘ä»¬å°†ä½¿ç”¨ Docker Compose ç¼–æ’ PostgreSQL æ•°æ®åº“å’Œ pgvector æ‰©å±•ã€‚

## ğŸ“‹ æœ¬èŠ‚ç›®æ ‡

- ç†è§£ Docker Compose çš„ä½œç”¨
- é…ç½® PostgreSQL æ•°æ®åº“
- å®‰è£… pgvector æ‰©å±•ï¼ˆå‘é‡æ£€ç´¢æ”¯æŒï¼‰
- å¯åŠ¨å¹¶éªŒè¯æ•°æ®åº“æœåŠ¡

## ğŸ¯ æœ¬èŠ‚è¦ç‚¹

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸€èŠ‚ï¼Ÿ**

MiniClaw éœ€è¦ä¸€ä¸ªæ•°æ®åº“æ¥å­˜å‚¨ï¼š
- **ä¼šè¯æ•°æ®**ï¼šç”¨æˆ·ä¸ Agent çš„å¯¹è¯è®°å½•
- **å‘é‡æ•°æ®**ï¼šAI ç”Ÿæˆçš„è¯­ä¹‰å‘é‡ï¼ˆç”¨äº Memory ç³»ç»Ÿï¼‰

è€Œ Docker Compose å¸®æˆ‘ä»¬å¿«é€Ÿæ­å»ºè¿™ä¸ªæ•°æ®åº“ç¯å¢ƒï¼Œæ— éœ€æ‰‹åŠ¨å®‰è£… PostgreSQLã€‚

**æ ¸å¿ƒæ¦‚å¿µï¼š**

1. **Docker**ï¼šå®¹å™¨åŒ–æŠ€æœ¯ï¼ŒæŠŠ PostgreSQL æ‰“åŒ…æˆä¸€ä¸ª"å®¹å™¨"ï¼Œåœ¨ä»»ä½•ç³»ç»Ÿä¸Šéƒ½èƒ½è¿è¡Œ
2. **Docker Compose**ï¼šç”¨é…ç½®æ–‡ä»¶å®šä¹‰å®¹å™¨ï¼Œä¸€é”®å¯åŠ¨/åœæ­¢
3. **pgvector**ï¼šPostgreSQL æ‰©å±•ï¼Œæ”¯æŒå‘é‡å­˜å‚¨å’Œç›¸ä¼¼åº¦æ£€ç´¢
4. **æ•°æ®æŒä¹…åŒ–**ï¼šå®¹å™¨åˆ é™¤åæ•°æ®ä¸ä¸¢å¤±ï¼ˆé€šè¿‡ Volumeï¼‰

**æœ¬èŠ‚å®Œæˆåï¼Œä½ ä¼šå¾—åˆ°ï¼š**

- âœ… ä¸€ä¸ªè¿è¡Œä¸­çš„ PostgreSQL æ•°æ®åº“ï¼ˆç«¯å£ 5432ï¼‰
- âœ… å·²å®‰è£… pgvector æ‰©å±•ï¼ˆå‘é‡æ£€ç´¢èƒ½åŠ›ï¼‰
- âœ… æ•°æ®æŒä¹…åŒ–é…ç½®ï¼ˆé‡å¯ä¸ä¸¢æ•°æ®ï¼‰

## ğŸ³ Docker åšäº†ä»€ä¹ˆï¼Ÿ

### ä¼ ç»Ÿæ–¹å¼ vs Docker æ–¹å¼

**ä¼ ç»Ÿæ–¹å¼ï¼ˆæ‰‹åŠ¨å®‰è£… PostgreSQLï¼‰ï¼š**

```
1. ä¸‹è½½ PostgreSQL å®‰è£…åŒ…
2. å®‰è£…åˆ°æ“ä½œç³»ç»Ÿ
3. é…ç½®ç¯å¢ƒå˜é‡
4. åˆ›å»ºæ•°æ®åº“ç”¨æˆ·
5. å®‰è£… pgvector æ‰©å±•ï¼ˆéœ€è¦ç¼–è¯‘ï¼‰
6. é…ç½®å¼€æœºè‡ªå¯
...
```

**Docker æ–¹å¼ï¼ˆæœ¬èŠ‚ä½¿ç”¨ï¼‰ï¼š**

```
1. ç¼–å†™ docker-compose.ymlï¼ˆé…ç½®æ–‡ä»¶ï¼‰
2. docker-compose up -dï¼ˆä¸€æ¡å‘½ä»¤å¯åŠ¨ï¼‰
âœ… å®Œæˆï¼
```

### Docker çš„å·¥ä½œæµç¨‹

```mermaid
graph LR
    A[ç¼–å†™ docker-compose.yml] --> B[docker-compose up -d]
    B --> C[Docker ä¸‹è½½é•œåƒ]
    C --> D[åˆ›å»ºå®¹å™¨]
    D --> E[æ‰§è¡Œ init.sql]
    E --> F[PostgreSQL å¯åŠ¨å®Œæˆ]
    F --> G[åº”ç”¨è¿æ¥æ•°æ®åº“]
```

**å…³é”®æ­¥éª¤ï¼š**

1. **ä¸‹è½½é•œåƒ**ï¼šDocker ä» Docker Hub ä¸‹è½½ `pgvector/pgvector:pg16` é•œåƒï¼ˆå·²åŒ…å« PostgreSQL 16 + pgvectorï¼‰
2. **åˆ›å»ºå®¹å™¨**ï¼šæ ¹æ®é…ç½®åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å®¹å™¨ç¯å¢ƒ
3. **æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬**ï¼šè‡ªåŠ¨è¿è¡Œ `init.sql`ï¼Œå®‰è£…æ‰©å±•
4. **å¯åŠ¨æ•°æ®åº“**ï¼šPostgreSQL åœ¨å®¹å™¨å†…å¯åŠ¨
5. **æ˜ å°„ç«¯å£**ï¼šå®¹å™¨çš„ 5432 ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œåº”ç”¨å¯ä»¥é€šè¿‡ `localhost:5432` è¿æ¥

### æ•°æ®æŒä¹…åŒ–åŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Docker å®¹å™¨     â”‚
â”‚                 â”‚
â”‚  PostgreSQL     â”‚
â”‚     â†“           â”‚
â”‚  /var/lib/...   â”‚
â”‚     â†“           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    Volume æŒ‚è½½
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¿ä¸»æœºç£ç›˜      â”‚
â”‚  postgres_data  â”‚
â”‚  ï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹ï¼š**
- å®¹å™¨å†…çš„æ•°æ®å­˜å‚¨åœ¨ `/var/lib/postgresql/data`
- è¿™ä¸ªç›®å½•æŒ‚è½½åˆ°å®¿ä¸»æœºçš„ Volume `postgres_data`
- å³ä½¿åˆ é™¤å®¹å™¨ï¼ŒVolume ä¸­çš„æ•°æ®ä¾ç„¶å­˜åœ¨
- ä¸‹æ¬¡å¯åŠ¨æ–°å®¹å™¨ï¼Œä¼šè‡ªåŠ¨æŒ‚è½½è¿™ä¸ª Volumeï¼Œæ•°æ®æ¢å¤

## ğŸ“¦ æ–‡ä»¶ç»“æ„

æœ¬èŠ‚åˆ›å»ºçš„æ–‡ä»¶ï¼š

```
miniclaw-learn/
â”œâ”€â”€ docker-compose.yml           # Docker Compose é…ç½®
â”‚                                 # å®šä¹‰äº† PostgreSQL å®¹å™¨çš„é…ç½®
â””â”€â”€ docker/
    â””â”€â”€ postgres/
        â””â”€â”€ init.sql             # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
                                  # å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ
```

## ğŸ“„ é…ç½®æ–‡ä»¶è§£æ

### docker-compose.yml

```yaml
version: '3.8'

services:
  postgres:
    image: pgvector/pgvector:pg16
    container_name: miniclaw-learn-postgres
    environment:
      POSTGRES_USER: miniclaw
      POSTGRES_PASSWORD: miniclaw123
      POSTGRES_DB: miniclaw
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U miniclaw -d miniclaw"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
```

**å…³é”®é…ç½®è¯´æ˜ï¼š**

| é…ç½®é¡¹ | è¯´æ˜ | æ³¨æ„äº‹é¡¹ |
|--------|------|----------|
| `image: pgvector/pgvector:pg16` | ä½¿ç”¨ PostgreSQL 16 + pgvector é•œåƒ | å®˜æ–¹æ¨èç‰ˆæœ¬ |
| `POSTGRES_PASSWORD` | æ•°æ®åº“å¯†ç  | ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨å¼ºå¯†ç  |
| `volumes: postgres_data` | æ•°æ®æŒä¹…åŒ– | åˆ é™¤å®¹å™¨ä¸ä¼šä¸¢å¤±æ•°æ® |
| `healthcheck` | å¥åº·æ£€æŸ¥ | ç¡®ä¿æ•°æ®åº“å·²å¯åŠ¨ |
| `restart: unless-stopped` | è‡ªåŠ¨é‡å¯ | é™¤éæ‰‹åŠ¨åœæ­¢ï¼Œå¦åˆ™è‡ªåŠ¨é‡å¯ |

### init.sql

```sql
-- pgvector æ‰©å±•ï¼šç”¨äºå‘é‡æ£€ç´¢ï¼ˆç¬¬ 10 ç«  Memory ç³»ç»Ÿä½¿ç”¨ï¼‰
CREATE EXTENSION IF NOT EXISTS vector;

-- uuid-ossp æ‰©å±•ï¼šç”¨äºè‡ªåŠ¨ç”Ÿæˆ UUID
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

**æ‰©å±•è¯´æ˜ï¼š**

- **pgvector**ï¼šPostgreSQL å‘é‡æ£€ç´¢æ‰©å±•ï¼Œç”¨äºå­˜å‚¨å’ŒæŸ¥è¯¢å‘é‡æ•°æ®ï¼ˆMemory ç³»ç»Ÿçš„è¯­ä¹‰æ£€ç´¢ï¼‰
- **uuid-ossp**ï¼šUUID ç”Ÿæˆæ‰©å±•ï¼Œç”¨äºè‡ªåŠ¨ç”Ÿæˆä¸»é”®

## ğŸš€ å¯åŠ¨æ•°æ®åº“

### 1. å®‰è£… Docker

**æ£€æŸ¥æ˜¯å¦å·²å®‰è£…ï¼š**

```bash
docker --version
docker-compose --version
```

**é¢„æœŸè¾“å‡ºï¼š**

```
Docker version 24.0.7
Docker Compose version v2.23.0
```

**å®‰è£…æ–¹æ³•ï¼š**

- **macOS**: ä¸‹è½½ [Docker Desktop](https://www.docker.com/products/docker-desktop/)
- **Ubuntu/Debian**: `sudo apt install docker.io docker-compose`
- **Windows**: ä¸‹è½½ [Docker Desktop](https://www.docker.com/products/docker-desktop/)

### 2. å¯åŠ¨æœåŠ¡

```bash
cd miniclaw-learn
docker-compose up -d
```

**é¢„æœŸè¾“å‡ºï¼š**

```
Creating network "miniclaw-learn_default" with the default driver
Creating volume "miniclaw-learn_postgres_data" with local driver
Pulling postgres (pgvector/pgvector:pg16)...
...
Creating miniclaw-learn-postgres ... done
```

### 3. æŸ¥çœ‹å®¹å™¨çŠ¶æ€

```bash
docker-compose ps
```

**é¢„æœŸè¾“å‡ºï¼š**

```
NAME                      STATUS              PORTS
miniclaw-learn-postgres   Up 10 seconds       0.0.0.0:5432->5432/tcp
```

### 4. æŸ¥çœ‹æ—¥å¿—

```bash
docker-compose logs postgres
```

**é¢„æœŸè¾“å‡ºï¼ˆæœ€åå‡ è¡Œï¼‰ï¼š**

```
PostgreSQL init process complete; ready for start up.
PostgreSQL extensions installed: vector, uuid-ossp
```

## âœ… éªŒè¯æ•°æ®åº“

### 1. è¿æ¥æ•°æ®åº“

```bash
# ä½¿ç”¨ psql å®¢æˆ·ç«¯è¿æ¥
psql -h localhost -U miniclaw -d miniclaw
```

**è¾“å…¥å¯†ç ï¼š** `miniclaw123`

### 2. éªŒè¯æ‰©å±•

```sql
-- æŸ¥çœ‹å·²å®‰è£…çš„æ‰©å±•
\dx
```

**é¢„æœŸè¾“å‡ºï¼š**

```
                                      List of installed extensions
   Name    | Version |   Schema   |                     Description
-----------+---------+------------+------------------------------------------------------
 plpgsql   | 1.0     | pg_catalog | PL/pgSQL procedural language
 uuid-ossp | 1.1     | public     | generate universally unique identifiers (UUIDs)
 vector    | 0.5.0   | public     | vector data type and ivfflat and hnsw access methods
(3 rows)
```

### 3. æµ‹è¯•å‘é‡åŠŸèƒ½

```sql
-- åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE test_vectors (
    id serial PRIMARY KEY,
    embedding vector(3)
);

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO test_vectors (embedding) VALUES ('[1,2,3]'), ('[4,5,6]');

-- æŸ¥è¯¢ç›¸ä¼¼å‘é‡
SELECT * FROM test_vectors ORDER BY embedding <-> '[1,2,3]' LIMIT 5;

-- æ¸…ç†æµ‹è¯•æ•°æ®
DROP TABLE test_vectors;

-- é€€å‡º
\q
```

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨æœåŠ¡
docker-compose up -d

# åœæ­¢æœåŠ¡
docker-compose stop

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨ï¼ˆä¿ç•™æ•°æ®ï¼‰
docker-compose down

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨å’Œæ•°æ®ï¼ˆå±é™©ï¼ï¼‰
docker-compose down -v

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f postgres

# é‡å¯æœåŠ¡
docker-compose restart

# è¿›å…¥å®¹å™¨
docker-compose exec postgres bash
```

## ğŸ› å¸¸è§é—®é¢˜

### 1. ç«¯å£è¢«å ç”¨

**é—®é¢˜ï¼š**

```
Error: port is already allocated
```

**è§£å†³æ–¹æ¡ˆï¼š**

æŸ¥çœ‹å ç”¨ç«¯å£çš„è¿›ç¨‹ï¼š

```bash
# macOS/Linux
lsof -i :5432

# åœæ­¢å ç”¨ç«¯å£çš„ PostgreSQL
sudo systemctl stop postgresql
```

æˆ–ä¿®æ”¹ `docker-compose.yml`ï¼š

```yaml
ports:
  - "5433:5432"  # ä½¿ç”¨å…¶ä»–ç«¯å£
```

### 2. æ•°æ®åº“å¯†ç é”™è¯¯

**é—®é¢˜ï¼š**

```
psql: error: connection to server on socket "/tmp/.s.PGSQL.5432" failed: FATAL:  password authentication failed
```

**è§£å†³æ–¹æ¡ˆï¼š**

ç¡®è®¤å¯†ç æ­£ç¡®ï¼ˆ`miniclaw123`ï¼‰ï¼Œæˆ–é‡ç½®æ•°æ®åº“ï¼š

```bash
docker-compose down -v
docker-compose up -d
```

### 3. å®¹å™¨å¯åŠ¨å¤±è´¥

**é—®é¢˜ï¼š**

```
ERROR: for miniclaw-learn-postgres  Cannot start service postgres
```

**è§£å†³æ–¹æ¡ˆï¼š**

æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š

```bash
docker-compose logs postgres
```

å¸¸è§åŸå› ï¼š
- Docker æœªå¯åŠ¨
- ç£ç›˜ç©ºé—´ä¸è¶³
- é•œåƒä¸‹è½½å¤±è´¥

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### ä¸ºä»€ä¹ˆç”¨ PostgreSQL è€Œä¸æ˜¯ MySQLï¼Ÿ

1. **pgvector æ‰©å±•**ï¼šPostgreSQL æœ‰æˆç†Ÿçš„å‘é‡æ£€ç´¢æ‰©å±•
2. **JSON æ”¯æŒ**ï¼šPostgreSQL çš„ JSONB ç±»å‹æ€§èƒ½æ›´å¥½
3. **å¼€æºç”Ÿæ€**ï¼šPostgreSQL ç¤¾åŒºæ´»è·ƒï¼Œæ‰©å±•ä¸°å¯Œ

### pgvector çš„ä½œç”¨

- **å‘é‡å­˜å‚¨**ï¼šå­˜å‚¨ Embedding å‘é‡ï¼ˆAI ç”Ÿæˆçš„è¯­ä¹‰å‘é‡ï¼‰
- **ç›¸ä¼¼åº¦æ£€ç´¢**ï¼šæ ¹æ®å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢æ•°æ®
- **Memory ç³»ç»Ÿ**ï¼šç¬¬ 10 ç« ä¼šç”¨ pgvector å®ç°è¯­ä¹‰æ£€ç´¢

### ä¸ºä»€ä¹ˆéœ€è¦ uuid-osspï¼Ÿ

- **è‡ªåŠ¨ç”Ÿæˆ UUID**ï¼šä¸»é”®ä¸éœ€è¦æ‰‹åŠ¨èµ‹å€¼
- **åˆ†å¸ƒå¼å‹å¥½**ï¼šUUID ä¸ä¼šå†²çª
- **å®‰å…¨æ€§**ï¼šUUID ä¸å¯é¢„æµ‹

## ğŸ“š æ‰©å±•é˜…è¯»

- [Docker Compose å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/compose/)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/16/index.html)
- [pgvector å®˜æ–¹æ–‡æ¡£](https://github.com/pgvector/pgvector)

## ğŸ¯ ä¸‹ä¸€æ­¥

ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†ï¼š
- ä½¿ç”¨ Flyway ç®¡ç†æ•°æ®åº“ç‰ˆæœ¬
- è®¾è®¡ Session/Run/Message æ•°æ®è¡¨
- åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬

[ä¸‹ä¸€èŠ‚ï¼š3.3 Flyway æ•°æ®åº“è¿ç§» â†’](./3.3-flyway.md)
