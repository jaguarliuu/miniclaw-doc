# 4.6 å¤šæ¨¡å‹é€‚é…

> æœ¬èŠ‚æˆ‘ä»¬å®ç°å¤š LLM Provider æ”¯æŒï¼ŒåŠ¨æ€åˆ‡æ¢ä¸åŒçš„æ¨¡å‹ã€‚

## æœ¬èŠ‚ç›®æ ‡

- æ”¯æŒé…ç½®å¤šä¸ª LLM Provider
- åŠ¨æ€åˆ‡æ¢ Provider å’Œæ¨¡å‹
- WebClient å®ä¾‹ç¼“å­˜ä¼˜åŒ–
- æ¯ä¸ª Provider æ”¯æŒå¤šä¸ªæ¨¡å‹

## ä¸ºä»€ä¹ˆéœ€è¦å¤šæ¨¡å‹ï¼Ÿ

**ä¸åŒåœºæ™¯ç”¨ä¸åŒæ¨¡å‹ï¼š**

| åœºæ™¯ | æ¨èæ¨¡å‹ | åŸå›  |
|------|---------|------|
| ä»£ç ç”Ÿæˆ | DeepSeek Coder | ä¾¿å®œï¼Œä»£ç èƒ½åŠ›å¼º |
| æ—¥å¸¸å¯¹è¯ | GPT-3.5 Turbo | å“åº”å¿«ï¼Œæˆæœ¬ä½ |
| å¤æ‚æ¨ç† | GPT-4 / Claude 3 | èƒ½åŠ›æœ€å¼º |
| æœ¬åœ°éƒ¨ç½² | Ollama | æ•°æ®ä¸å‡ºæœ¬åœ° |

**æˆæœ¬ä¼˜åŒ–ï¼š**

```
GPT-4ï¼š      $0.03/1k tokens
DeepSeekï¼š   $0.001/1k tokens  ï¼ˆä¾¿å®œ 30 å€ï¼ï¼‰
```

## é…ç½®ç»“æ„

### application.yml

```yaml
miniclaw:
  llm:
    providers:
      openai:
        endpoint: https://api.openai.com/v1
        api-key: ${OPENAI_API_KEY}
        models:
          - gpt-4
          - gpt-3.5-turbo
        default-model: gpt-3.5-turbo
      deepseek:
        endpoint: https://api.deepseek.com/v1
        api-key: ${DEEPSEEK_API_KEY}
        models:
          - deepseek-chat
          - deepseek-coder
        default-model: deepseek-chat
    default-provider: deepseek
    temperature: 0.7
    max-tokens: 4096
    timeout: 60
```

### ProviderConfig ç»“æ„

```java
@Data
public static class ProviderConfig {
    private String endpoint;        // API ç«¯ç‚¹
    private String apiKey;          // API Key
    private List<String> models;    // æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨
    private String defaultModel;    // é»˜è®¤æ¨¡å‹
}
```

## å®ç°æ ¸å¿ƒé€»è¾‘

### 1. åˆå§‹åŒ–æ‰€æœ‰ Provider

```java
public OpenAiCompatibleLlmClient(LlmProperties properties, ObjectMapper objectMapper) {
    this.properties = properties;
    this.objectMapper = objectMapper;

    // åˆå§‹åŒ–æ‰€æœ‰é…ç½®çš„ Provider
    properties.getProviders().forEach((providerId, config) -> {
        if (config.getEndpoint() != null && config.getApiKey() != null) {
            WebClient client = buildWebClient(config.getEndpoint(), config.getApiKey());
            clientCache.put(providerId, client);
            log.info("LLM Client initialized: provider={}, endpoint={}",
                providerId, config.getEndpoint());
        }
    });
}
```

**å…³é”®ç‚¹ï¼š**
- å¯åŠ¨æ—¶åˆå§‹åŒ–æ‰€æœ‰ Provider
- WebClient å®ä¾‹ç¼“å­˜ï¼ˆé¿å…é‡å¤åˆ›å»ºï¼‰
- æ—¥å¿—è®°å½•åˆå§‹åŒ–çŠ¶æ€

### 2. æŒ‡å®š Provider è°ƒç”¨

```java
// ä½¿ç”¨é»˜è®¤ Provider
LlmResponse response = client.chat(request);

// æŒ‡å®š Provider
LlmResponse response = client.chat(request, "openai");

// æµå¼è°ƒç”¨
Flux<LlmChunk> stream = client.stream(request, "deepseek");
```

### 3. Provider è§£æé€»è¾‘

```java
private WebClient resolveClient(String providerId) {
    // 1. æŒ‡å®šäº† Provider ID
    if (providerId != null) {
        WebClient client = clientCache.get(providerId);
        if (client != null) {
            return client;
        }
        log.warn("Provider not found: {}, falling back to default", providerId);
    }

    // 2. ä½¿ç”¨é»˜è®¤ Provider
    String defaultProviderId = properties.getDefaultProviderId();
    if (defaultProviderId != null) {
        WebClient client = clientCache.get(defaultProviderId);
        if (client != null) {
            return client;
        }
    }

    // 3. å…œåº•ï¼šä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„
    if (!clientCache.isEmpty()) {
        return clientCache.values().iterator().next();
    }

    return null;
}
```

**é™çº§ç­–ç•¥ï¼š**
1. ä¼˜å…ˆä½¿ç”¨æŒ‡å®šçš„ Provider
2. å…¶æ¬¡ä½¿ç”¨é»˜è®¤ Provider
3. æœ€åä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„

## å®é™…ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šä»£ç ç”Ÿæˆç”¨ DeepSeek Coder

```java
@Service
public class CodeService {

    @Autowired
    private OpenAiCompatibleLlmClient llmClient;

    public String generateCode(String requirement) {
        LlmRequest request = LlmRequest.builder()
            .messages(List.of(
                LlmRequest.Message.system("ä½ æ˜¯ä¸€ä¸ªä»£ç åŠ©æ‰‹"),
                LlmRequest.Message.user(requirement)
            ))
            .model("deepseek-coder")  // æŒ‡å®šæ¨¡å‹
            .build();

        return llmClient.chat(request, "deepseek").getContent();
    }
}
```

### ç¤ºä¾‹ 2ï¼šæ—¥å¸¸å¯¹è¯ç”¨ GPT-3.5

```java
public String chat(String userMessage) {
    LlmRequest request = LlmRequest.builder()
        .messages(List.of(
            LlmRequest.Message.user(userMessage)
        ))
        .build();

    return llmClient.chat(request, "openai").getContent();
}
```

### ç¤ºä¾‹ 3ï¼šåŠ¨æ€åˆ‡æ¢ Provider

```java
@RestController
public class ChatController {

    @Autowired
    private OpenAiCompatibleLlmClient llmClient;

    @PostMapping("/chat")
    public String chat(@RequestParam String message,
                       @RequestParam(required = false) String provider) {

        LlmRequest request = LlmRequest.builder()
            .messages(List.of(LlmRequest.Message.user(message)))
            .build();

        // æ ¹æ® provider å‚æ•°åŠ¨æ€é€‰æ‹©
        return llmClient.chat(request, provider).getContent();
    }
}
```

## å•å…ƒæµ‹è¯•

### æµ‹è¯• 1ï¼šè·å– Provider é…ç½®

```java
@Test
void testGetProvider() {
    LlmProperties properties = new LlmProperties();

    LlmProperties.ProviderConfig openai = new LlmProperties.ProviderConfig();
    openai.setEndpoint("https://api.openai.com/v1");
    openai.setModels(List.of("gpt-4"));

    properties.getProviders().put("openai", openai);

    assertNotNull(properties.getProvider("openai"));
    assertNull(properties.getProvider("deepseek"));
}
```

### æµ‹è¯• 2ï¼šè·å–é»˜è®¤æ¨¡å‹

```java
@Test
void testGetDefaultModel() {
    LlmProperties properties = new LlmProperties();

    LlmProperties.ProviderConfig deepseek = new LlmProperties.ProviderConfig();
    deepseek.setModels(List.of("deepseek-chat", "deepseek-coder"));
    deepseek.setDefaultModel("deepseek-coder");

    properties.getProviders().put("deepseek", deepseek);

    // åº”è¯¥è¿”å›é…ç½®çš„é»˜è®¤æ¨¡å‹
    assertEquals("deepseek-coder", properties.getDefaultModel("deepseek"));

    // æ²¡æœ‰é…ç½®é»˜è®¤ï¼Œè¿”å›åˆ—è¡¨ç¬¬ä¸€ä¸ª
    deepseek.setDefaultModel(null);
    assertEquals("deepseek-chat", properties.getDefaultModel("deepseek"));
}
```

### æµ‹è¯• 3ï¼šå¤š Provider é…ç½®

```java
@Test
void testMultipleProviders() {
    LlmProperties properties = new LlmProperties();

    LlmProperties.ProviderConfig openai = new LlmProperties.ProviderConfig();
    openai.setEndpoint("https://api.openai.com/v1");

    LlmProperties.ProviderConfig deepseek = new LlmProperties.ProviderConfig();
    deepseek.setEndpoint("https://api.deepseek.com/v1");

    properties.getProviders().put("openai", openai);
    properties.getProviders().put("deepseek", deepseek);
    properties.setDefaultProvider("deepseek");

    assertEquals(2, properties.getProviders().size());
    assertEquals("deepseek", properties.getDefaultProvider());
}
```

**æµ‹è¯•ç»“æœï¼š** 5/5 é€šè¿‡ âœ…

## é…ç½®æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ç¯å¢ƒå˜é‡

```yaml
providers:
  openai:
    api-key: ${OPENAI_API_KEY}  # ä»ç¯å¢ƒå˜é‡è¯»å–
```

**å¥½å¤„ï¼š**
- å®‰å…¨ï¼ˆä¸æäº¤åˆ° Gitï¼‰
- çµæ´»ï¼ˆä¸åŒç¯å¢ƒä¸åŒé…ç½®ï¼‰

### 2. æˆæœ¬ä¼˜å…ˆç­–ç•¥

```yaml
default-provider: deepseek  # é»˜è®¤ç”¨ä¾¿å®œçš„

# éœ€è¦å¼ºèƒ½åŠ›æ—¶æ˜¾å¼æŒ‡å®š
llmClient.chat(request, "openai");  // æŒ‡å®šç”¨ GPT-4
```

### 3. æœ¬åœ°å¼€å‘é…ç½®

```yaml
providers:
  ollama:
    endpoint: http://localhost:11434/v1
    api-key: dummy
    models:
      - llama2
      - codellama
```

## å¸¸è§é—®é¢˜

### 1. Provider ä¸å­˜åœ¨

**é—®é¢˜ï¼š** æŒ‡å®šäº†ä¸å­˜åœ¨çš„ Provider

**è§£å†³ï¼š** è‡ªåŠ¨é™çº§åˆ°é»˜è®¤ Provider

```java
WebClient client = clientCache.get(providerId);
if (client == null) {
    log.warn("Provider not found: {}, falling back to default", providerId);
    client = resolveClient(null);  // é™çº§
}
```

### 2. API Key æ³„éœ²

**é—®é¢˜ï¼š** API Key æäº¤åˆ° Git

**è§£å†³ï¼š** ä½¿ç”¨ç¯å¢ƒå˜é‡

```bash
export OPENAI_API_KEY="sk-xxx"
export DEEPSEEK_API_KEY="sk-xxx"
```

### 3. æ¨¡å‹ä¸å­˜åœ¨

**é—®é¢˜ï¼š** æŒ‡å®šçš„æ¨¡å‹ä¸å­˜åœ¨

**è§£å†³ï¼š** API ä¼šè¿”å›é”™è¯¯ï¼Œå®¢æˆ·ç«¯æ•è·å¼‚å¸¸

```java
try {
    return llmClient.chat(request, provider);
} catch (LlmException e) {
    log.error("Model not found: {}", request.getModel());
    throw e;
}
```

## æµ‹è¯•ç»“æœ

**æ‰€æœ‰æµ‹è¯•ï¼š**
- âœ… 28/28 é€šè¿‡
- âœ… å¤š Provider é…ç½®æ­£ç¡®
- âœ… Provider è§£æé€»è¾‘æ­£ç¡®
- âœ… é»˜è®¤æ¨¡å‹é€‰æ‹©æ­£ç¡®

## ç¬¬å››ç« å®Œæˆï¼ğŸ‰

**å­¦åˆ°äº†ä»€ä¹ˆï¼š**
- âœ… OpenAI å…¼å®¹å®¢æˆ·ç«¯è®¾è®¡
- âœ… åŒæ­¥å’Œæµå¼è°ƒç”¨
- âœ… SSE åè®®å¤„ç†
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•
- âœ… å¤šæ¨¡å‹é€‚é…

**ä¸‹ä¸€ç« ï¼š**
ç¬¬äº”ç« æˆ‘ä»¬å°†å­¦ä¹ æ•°æ®æŒä¹…åŒ–ï¼ŒåŒ…æ‹¬ Session ç®¡ç†ã€æ¶ˆæ¯å­˜å‚¨ã€æˆæœ¬ç»Ÿè®¡ã€‚

[ä¸‹ä¸€ç« ï¼šç¬¬äº”ç«  æ•°æ®æŒä¹…åŒ– â†’](../chapter-05/5.1-session-management.md)
