# 4.3 åŒæ­¥è°ƒç”¨å®ç°

> æœ¬èŠ‚æˆ‘ä»¬å°†å®ç° OpenAI å…¼å®¹å®¢æˆ·ç«¯çš„åŒæ­¥è°ƒç”¨åŠŸèƒ½ã€‚

## ğŸ“‹ æœ¬èŠ‚ç›®æ ‡

- å®ç° LlmClient.chat() æ–¹æ³•
- ä½¿ç”¨ WebClient å‘é€ HTTP è¯·æ±‚
- è§£æ OpenAI API å“åº”
- æ·»åŠ å®Œå–„çš„å•å…ƒæµ‹è¯•

## ğŸ¯ æœ¬èŠ‚è¦ç‚¹

**åŒæ­¥è°ƒç”¨ vs æµå¼è°ƒç”¨**

| ç‰¹æ€§ | åŒæ­¥è°ƒç”¨ | æµå¼è°ƒç”¨ |
|------|----------|----------|
| **è¿”å›æ–¹å¼** | ç­‰å¾…å®Œæ•´å“åº” | å®æ—¶è¿”å› chunks |
| **ç”¨æˆ·ä½“éªŒ** | ç­‰å¾…æ—¶é—´é•¿ | è¾¹ç”Ÿæˆè¾¹æ˜¾ç¤º |
| **é€‚ç”¨åœºæ™¯** | æ‰¹å¤„ç†ã€åå°ä»»åŠ¡ | å¯¹è¯ã€å®æ—¶å±•ç¤º |
| **å®ç°éš¾åº¦** | ç®€å• | å¤æ‚ï¼ˆç¬¬ 4.4 èŠ‚ï¼‰ |

æœ¬èŠ‚å®ç°åŒæ­¥è°ƒç”¨ï¼Œæµå¼è°ƒç”¨ç•™åˆ° 4.4 èŠ‚ã€‚

---

## ğŸ—ï¸ æ ¸å¿ƒå®ç°

### 1. LlmProperties é…ç½®ç±»

```java
@Data
@Component
@ConfigurationProperties(prefix = "miniclaw.llm")
public class LlmProperties {
    private String endpoint;      // API ç«¯ç‚¹
    private String apiKey;        // API Key
    private String model;         // é»˜è®¤æ¨¡å‹
    private Integer timeout = 60; // è¶…æ—¶æ—¶é—´
    private Double temperature = 0.7;
    private Integer maxTokens = 4096;
}
```

**é…ç½®ç¤ºä¾‹ï¼ˆapplication.ymlï¼‰ï¼š**

```yaml
miniclaw:
  llm:
    endpoint: https://api.openai.com/v1
    api-key: ${LLM_API_KEY}
    model: gpt-4
    timeout: 60
    temperature: 0.7
    max-tokens: 4096
```

**ç¯å¢ƒå˜é‡æ³¨å…¥ï¼š**

```bash
export LLM_API_KEY="sk-xxx"
export LLM_ENDPOINT="https://api.deepseek.com/v1"
export LLM_MODEL="deepseek-chat"
```

### 2. OpenAiCompatibleLlmClient æ ¸å¿ƒå®ç°

#### 2.1 åˆå§‹åŒ– WebClient

```java
public OpenAiCompatibleLlmClient(LlmProperties properties, ObjectMapper objectMapper) {
    this.properties = properties;
    this.objectMapper = objectMapper;

    if (properties.getEndpoint() != null) {
        this.webClient = buildWebClient(properties.getEndpoint(), properties.getApiKey());
    }
}

private WebClient buildWebClient(String endpoint, String apiKey) {
    return WebClient.builder()
        .baseUrl(endpoint)
        .defaultHeader("Authorization", "Bearer " + apiKey)
        .defaultHeader("Content-Type", "application/json")
        .build();
}
```

**WebClient vs RestTemplateï¼š**

| ç‰¹æ€§ | RestTemplate | WebClient |
|------|--------------|-----------|
| **ç¼–ç¨‹æ¨¡å‹** | åŒæ­¥é˜»å¡ | å“åº”å¼éé˜»å¡ |
| **æµå¼æ”¯æŒ** | âŒ ä¸æ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒ |
| **æ€§èƒ½** | ä¸€èˆ¬ | æ›´å¥½ |
| **Spring Boot 3.x** | ä¸æ¨è | æ¨è |

**ä¸ºä»€ä¹ˆç”¨ WebClientï¼Ÿ**
- ç¬¬ 4.4 èŠ‚æµå¼è¾“å‡ºéœ€è¦
- å“åº”å¼ç¼–ç¨‹æ›´å¼ºå¤§
- Spring Boot 3.x æ¨èæ–¹æ¡ˆ

#### 2.2 å®ç° chat() æ–¹æ³•

```java
@Override
public LlmResponse chat(LlmRequest request) {
    if (webClient == null) {
        throw new LlmException("LLM client not configured");
    }

    try {
        // 1. æ„å»º API è¯·æ±‚
        ChatCompletionRequest apiRequest = buildApiRequest(request, false);

        // 2. å‘é€è¯·æ±‚
        String responseBody = webClient.post()
            .uri("/chat/completions")
            .bodyValue(apiRequest)
            .retrieve()
            .bodyToMono(String.class)
            .timeout(Duration.ofSeconds(properties.getTimeout()))
            .block();  // åŒæ­¥é˜»å¡ç­‰å¾…

        // 3. è§£æå“åº”
        return parseResponse(responseBody);

    } catch (Exception e) {
        log.error("LLM chat failed", e);
        throw new LlmException("LLM chat failed: " + e.getMessage(), e);
    }
}
```

**å…³é”®æ­¥éª¤ï¼š**

1. **æ„å»ºè¯·æ±‚** - è½¬æ¢ä¸º OpenAI API æ ¼å¼
2. **å‘é€è¯·æ±‚** - POST /chat/completions
3. **è§£æå“åº”** - ä» JSON æå–å†…å®¹

#### 2.3 æ„å»ºè¯·æ±‚

```java
private ChatCompletionRequest buildApiRequest(LlmRequest request, boolean stream) {
    ChatCompletionRequest apiRequest = new ChatCompletionRequest();

    // æ¨¡å‹
    apiRequest.setModel(request.getModel() != null ? 
        request.getModel() : properties.getModel());

    // æ¶ˆæ¯
    List<Map<String, Object>> messages = new ArrayList<>();
    for (LlmRequest.Message message : request.getMessages()) {
        Map<String, Object> msg = new HashMap<>();
        msg.put("role", message.getRole());
        msg.put("content", message.getContent());
        // ... å¤„ç† tool_calls ç­‰
        messages.add(msg);
    }
    apiRequest.setMessages(messages);

    // å‚æ•°
    apiRequest.setTemperature(request.getTemperature() != null ? 
        request.getTemperature() : properties.getTemperature());
    apiRequest.setStream(stream);

    return apiRequest;
}
```

#### 2.4 è§£æå“åº”

```java
private LlmResponse parseResponse(String responseBody) {
    JsonNode root = objectMapper.readTree(responseBody);
    JsonNode choice = root.path("choices").get(0);
    JsonNode message = choice.path("message");

    // è§£æå†…å®¹
    String content = message.path("content").asText(null);

    // è§£æå·¥å…·è°ƒç”¨
    List<ToolCall> toolCalls = parseToolCalls(message.path("tool_calls"));

    // è§£æå®ŒæˆåŸå› 
    String finishReason = choice.path("finish_reason").asText(null);

    // è§£æ token ä½¿ç”¨
    LlmResponse.Usage usage = parseUsage(root.path("usage"));

    return LlmResponse.builder()
        .content(content)
        .toolCalls(toolCalls)
        .finishReason(finishReason)
        .usage(usage)
        .build();
}
```

---

## ğŸ” å®é™…åº”ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šç®€å•å¯¹è¯

```java
@Autowired
private LlmClient llmClient;

public String chat(String userMessage) {
    LlmRequest request = LlmRequest.builder()
        .messages(List.of(
            LlmRequest.Message.user(userMessage)
        ))
        .build();

    LlmResponse response = llmClient.chat(request);
    return response.getContent();
}
```

### ç¤ºä¾‹ 2ï¼šå¤šè½®å¯¹è¯

```java
public String multiTurnChat(List<String> userMessages) {
    List<LlmRequest.Message> messages = new ArrayList<>();

    for (int i = 0; i < userMessages.size(); i++) {
        // ç”¨æˆ·æ¶ˆæ¯
        messages.add(LlmRequest.Message.user(userMessages.get(i)));

        // AI å“åº”ï¼ˆé™¤äº†æœ€åä¸€æ¬¡ï¼‰
        if (i < userMessages.size() - 1) {
            LlmResponse response = llmClient.chat(LlmRequest.builder()
                .messages(messages)
                .build());
            messages.add(LlmRequest.Message.assistant(response.getContent()));
        }
    }

    LlmResponse response = llmClient.chat(LlmRequest.builder()
        .messages(messages)
        .build());

    return response.getContent();
}
```

### ç¤ºä¾‹ 3ï¼šå¸¦ç³»ç»Ÿæç¤º

```java
public String chatWithSystem(String systemPrompt, String userMessage) {
    LlmRequest request = LlmRequest.builder()
        .messages(List.of(
            LlmRequest.Message.system(systemPrompt),
            LlmRequest.Message.user(userMessage)
        ))
        .build();

    return llmClient.chat(request).getContent();
}
```

---

## âœ… å•å…ƒæµ‹è¯•

### æµ‹è¯• 1ï¼šå®¢æˆ·ç«¯åˆå§‹åŒ–

```java
@Test
void testClientInitialization() {
    assertNotNull(client);
    assertEquals("https://api.openai.com/v1", properties.getEndpoint());
    assertEquals("gpt-4", properties.getModel());
}
```

### æµ‹è¯• 2ï¼šæœªé…ç½®ç«¯ç‚¹

```java
@Test
void testClientWithoutEndpoint() {
    LlmProperties emptyProps = new LlmProperties();
    OpenAiCompatibleLlmClient emptyClient = new OpenAiCompatibleLlmClient(emptyProps, objectMapper);

    assertThrows(LlmException.class, () -> {
        emptyClient.chat(LlmRequest.builder()
            .messages(List.of(LlmRequest.Message.user("test")))
            .build());
    });
}
```

### æµ‹è¯• 3ï¼šæµå¼è°ƒç”¨æœªå®ç°

```java
@Test
void testStreamNotImplemented() {
    assertThrows(UnsupportedOperationException.class, () -> {
        client.stream(request);
    });
}
```

**æµ‹è¯•ç»“æœï¼š**
- âœ… 19/19 é€šè¿‡
- âœ… è¦†ç›–åˆå§‹åŒ–ã€é…ç½®ã€å¼‚å¸¸å¤„ç†

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. è¿æ¥è¶…æ—¶

**é—®é¢˜ï¼š**

```
LLM chat failed: Connection timed out
```

**è§£å†³æ–¹æ¡ˆï¼š**

å¢åŠ è¶…æ—¶æ—¶é—´ï¼š

```yaml
miniclaw:
  llm:
    timeout: 120  # å¢åŠ åˆ° 120 ç§’
```

### 2. API Key é”™è¯¯

**é—®é¢˜ï¼š**

```
401 Unauthorized
```

**è§£å†³æ–¹æ¡ˆï¼š**

æ£€æŸ¥ API Keyï¼š

```bash
# æŸ¥çœ‹ç¯å¢ƒå˜é‡
echo $LLM_API_KEY

# è®¾ç½®ç¯å¢ƒå˜é‡
export LLM_API_KEY="sk-xxx"
```

### 3. æ¨¡å‹ä¸å­˜åœ¨

**é—®é¢˜ï¼š**

```
Model 'gpt-5' not found
```

**è§£å†³æ–¹æ¡ˆï¼š**

ä½¿ç”¨æ­£ç¡®çš„æ¨¡å‹åç§°ï¼š

```yaml
miniclaw:
  llm:
    model: gpt-4  # æˆ– gpt-3.5-turbo
```

---

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### WebClient åŒæ­¥è°ƒç”¨çš„åŸç†

è™½ç„¶ WebClient æ˜¯å“åº”å¼çš„ï¼Œä½†æˆ‘ä»¬ç”¨ `.block()` å®ç°åŒæ­¥è°ƒç”¨ï¼š

```java
String response = webClient.post()
    .uri("/chat/completions")
    .bodyValue(request)
    .retrieve()
    .bodyToMono(String.class)  // Mono<String> - å“åº”å¼
    .block();                   // é˜»å¡ç­‰å¾…ç»“æœ
```

**Mono vs Fluxï¼š**

| ç±»å‹ | è¯´æ˜ | è¿”å›å€¼ |
|------|------|--------|
| `Mono<T>` | 0 æˆ– 1 ä¸ªå…ƒç´  | å•ä¸ªå“åº” |
| `Flux<T>` | 0 åˆ° N ä¸ªå…ƒç´  | æµå¼å“åº” |

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**
- ç»Ÿä¸€ä½¿ç”¨ WebClient
- ç¬¬ 4.4 èŠ‚æµå¼è¾“å‡ºæ—¶åªéœ€æ”¹ç”¨ `bodyToFlux()`
- ä»£ç å¤ç”¨æ€§é«˜

### ObjectMapper çš„ä½œç”¨

```java
private final ObjectMapper objectMapper;

// è§£æ JSON
JsonNode root = objectMapper.readTree(responseBody);

// æå–å­—æ®µ
String content = message.path("content").asText(null);
```

**Jackson ObjectMapperï¼š**
- Spring Boot è‡ªåŠ¨é…ç½®
- ç”¨äº JSON åºåˆ—åŒ–å’Œååºåˆ—åŒ–
- çº¿ç¨‹å®‰å…¨ï¼ˆå¯å¤ç”¨ï¼‰

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. è¿æ¥æ± é…ç½®

```java
private WebClient buildWebClient(String endpoint, String apiKey) {
    HttpClient httpClient = HttpClient.create()
        .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 10000)
        .responseTimeout(Duration.ofSeconds(60));

    return WebClient.builder()
        .baseUrl(endpoint)
        .clientConnector(new ReactorClientHttpConnector(httpClient))
        .defaultHeader("Authorization", "Bearer " + apiKey)
        .build();
}
```

### 2. é‡è¯•æœºåˆ¶

```java
.retryWhen(Retry.backoff(3, Duration.ofSeconds(1))
    .filter(e -> e instanceof WebClientException))
```

### 3. ç¼“å­˜ï¼ˆåç»­ç« èŠ‚å®ç°ï¼‰

```java
// ç¼“å­˜ WebClient å®ä¾‹
private final ConcurrentHashMap<String, WebClient> clientCache;
```

---

## ğŸ“š æ‰©å±•é˜…è¯»

- [WebClient å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-client)
- [OpenAI API æ–‡æ¡£](https://platform.openai.com/docs/api-reference/chat)
- [Project Reactor](https://projectreactor.io/)

---

## ğŸ¯ ä¸‹ä¸€èŠ‚

ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†ï¼š
- å®ç° SSE æµå¼è¾“å‡º
- å¤„ç† delta å¢é‡
- å®ç° Reactor Flux æµå¼ç®¡é“

[ä¸‹ä¸€èŠ‚ï¼š4.4 SSE åè®®ä¸æµå¼è¾“å‡º â†’](./4.4-sse-streaming.md)
