# 5.0 æœ¬ç« ä»‹ç»

> åœ¨æ„å»º AI Agent ç³»ç»Ÿæ—¶ï¼Œå®æ—¶é€šä¿¡æ˜¯æ ¸å¿ƒåŸºç¡€è®¾æ–½ã€‚æœ¬ç« æˆ‘ä»¬å°†å®ç°åŸºäº WebSocket çš„ RPC æ¶æ„ã€‚

## ä¸ºä»€ä¹ˆç”¨ WebSocket è€Œä¸æ˜¯ REST APIï¼Ÿ

### REST API çš„é—®é¢˜

**åœºæ™¯ï¼šç”¨æˆ·é—®"ä»‹ç»ä¸€ä¸‹ OpenClaw"**

```
âŒ REST API æµç¨‹ï¼š
1. å®¢æˆ·ç«¯ POST /api/chat
2. æœåŠ¡å™¨è°ƒç”¨ LLMï¼ˆç­‰å¾… 10-30 ç§’ï¼‰
3. æœåŠ¡å™¨è¿”å›å®Œæ•´å“åº”
4. å®¢æˆ·ç«¯ä¸€æ¬¡æ€§æ”¶åˆ°å…¨éƒ¨å†…å®¹

é—®é¢˜ï¼š
- ç”¨æˆ·è¦ç­‰ 10-30 ç§’æ‰çœ‹åˆ°ç¬¬ä¸€ä¸ªå­—
- æ— æ³•æ˜¾ç¤º"æ­£åœ¨è¾“å…¥..."çŠ¶æ€
- æ— æ³•å®æ—¶çœ‹åˆ° AI ç”Ÿæˆè¿‡ç¨‹
- ä½“éªŒå·®
```

**åœºæ™¯ï¼šAgent æ‰§è¡Œéœ€è¦ 5 åˆ†é’Ÿ**

```
âŒ REST API æµç¨‹ï¼š
1. å®¢æˆ·ç«¯ POST /api/agent/run
2. æœåŠ¡å™¨æ‰§è¡Œ 5 åˆ†é’Ÿ
3. HTTP è¶…æ—¶ï¼ˆé»˜è®¤ 30-60 ç§’ï¼‰
4. è¿æ¥æ–­å¼€ï¼Œä»»åŠ¡å¤±è´¥

é—®é¢˜ï¼š
- é•¿æ—¶é—´ä»»åŠ¡æ— æ³•å¤„ç†
- æ— æ³•å–æ¶ˆæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡
- æ— æ³•çœ‹åˆ°æ‰§è¡Œè¿›åº¦
```

### WebSocket çš„ä¼˜åŠ¿

**åœºæ™¯ï¼šç”¨æˆ·é—®"ä»‹ç»ä¸€ä¸‹ OpenClaw"**

```
âœ… WebSocket æµç¨‹ï¼š
1. å®¢æˆ·ç«¯å»ºç«‹ WebSocket è¿æ¥
2. å®¢æˆ·ç«¯å‘é€ RPC è¯·æ±‚ï¼š{"method": "agent.run", ...}
3. æœåŠ¡å™¨ç«‹å³è¿”å›ï¼š{"result": {"runId": "xxx"}}
4. æœåŠ¡å™¨æ¨é€äº‹ä»¶æµï¼š
   - {"event": "run.started", "runId": "xxx"}
   - {"event": "run.progress", "delta": "OpenClaw"}
   - {"event": "run.progress", "delta": "æ˜¯"}
   - {"event": "run.progress", "delta": "ä¸€ä¸ª"}
   - ...
   - {"event": "run.completed", "runId": "xxx"}

ä¼˜åŠ¿ï¼š
- ç”¨æˆ·ç«‹å³çœ‹åˆ° AI åœ¨"æ‰“å­—"
- å®æ—¶æ˜¾ç¤ºç”Ÿæˆè¿‡ç¨‹
- å¯ä»¥éšæ—¶å–æ¶ˆ
- ä½“éªŒå¥½
```

**åœºæ™¯ï¼šAgent æ‰§è¡Œéœ€è¦ 5 åˆ†é’Ÿ**

```
âœ… WebSocket æµç¨‹ï¼š
1. å®¢æˆ·ç«¯å‘é€ RPC è¯·æ±‚
2. æœåŠ¡å™¨ç«‹å³è¿”å› runId
3. æœåŠ¡å™¨æŒç»­æ¨é€è¿›åº¦äº‹ä»¶ï¼š
   - {"event": "run.progress", "step": 1, "total": 10}
   - {"event": "run.progress", "step": 2, "total": 10}
   - ...
4. å®¢æˆ·ç«¯æ˜¾ç¤ºè¿›åº¦æ¡
5. å®¢æˆ·ç«¯å¯ä»¥å‘é€å–æ¶ˆè¯·æ±‚

ä¼˜åŠ¿ï¼š
- æ”¯æŒé•¿æ—¶é—´ä»»åŠ¡
- å®æ—¶è¿›åº¦åé¦ˆ
- å¯å–æ¶ˆ
- ä¸ä¼šè¶…æ—¶
```

---

## RPC vs REST çš„åŒºåˆ«

### REST API

```
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼šHTTP POST /api/chat
æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼šHTTP 200 OK + JSON

ç‰¹ç‚¹ï¼š
- å•å‘è¯·æ±‚-å“åº”
- åŒæ­¥é˜»å¡
- æ— çŠ¶æ€
- ç®€å•ç›´è§‚
```

**é€‚ç”¨åœºæ™¯ï¼š**
- ç®€å•çš„ CRUD æ“ä½œ
- ä¸éœ€è¦å®æ—¶åé¦ˆ
- çŸ­æ—¶é—´æ“ä½œ

### RPC (Remote Procedure Call)

```
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼šWebSocket æ¶ˆæ¯ {"method": "agent.run", ...}
æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼šWebSocket æ¶ˆæ¯ {"result": {"runId": "xxx"}}
æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼šWebSocket æ¶ˆæ¯ {"event": "run.progress", ...}
æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼šWebSocket æ¶ˆæ¯ {"event": "run.progress", ...}
æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼šWebSocket æ¶ˆæ¯ {"event": "run.completed", ...}

ç‰¹ç‚¹ï¼š
- åŒå‘é€šä¿¡
- å¼‚æ­¥éé˜»å¡
- äº‹ä»¶é©±åŠ¨
- å®æ—¶æ¨é€
```

**é€‚ç”¨åœºæ™¯ï¼š**
- å®æ—¶é€šä¿¡
- é•¿æ—¶é—´ä»»åŠ¡
- éœ€è¦è¿›åº¦åé¦ˆ
- æµå¼è¾“å‡º

---

## MiniClaw çš„å®æ—¶é€šä¿¡æ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â”‚  (Browser)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ WebSocket
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GatewayWebSocketHandlerâ”‚ â† è¿æ¥ç®¡ç†
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      RpcRouter          â”‚ â† è·¯ç”±åˆ†å‘
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      RpcHandler         â”‚ â† ä¸šåŠ¡å¤„ç†
â”‚  (agent.run, etc.)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      EventBus           â”‚ â† äº‹ä»¶æ¨é€
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WebSocket Push        â”‚ â† å®æ—¶é€šçŸ¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. WebSocket è¿æ¥å±‚

**èŒè´£ï¼š**
- å»ºç«‹ WebSocket è¿æ¥
- ç®¡ç†è¿æ¥ç”Ÿå‘½å‘¨æœŸ
- å¿ƒè·³æ£€æµ‹
- æ–­çº¿é‡è¿

**æ ¸å¿ƒç±»ï¼š**
- `GatewayWebSocketHandler` - WebSocket å¤„ç†å™¨
- `ConnectionManager` - è¿æ¥ç®¡ç†å™¨

#### 2. RPC åè®®å±‚

**èŒè´£ï¼š**
- å®šä¹‰é€šä¿¡åè®®
- è¯·æ±‚/å“åº”/äº‹ä»¶æ ¼å¼
- é”™è¯¯å¤„ç†

**æ ¸å¿ƒç±»ï¼š**
- `RpcRequest` - è¯·æ±‚æ¨¡å‹
- `RpcResponse` - å“åº”æ¨¡å‹
- `RpcEvent` - äº‹ä»¶æ¨¡å‹

#### 3. RPC è·¯ç”±å±‚

**èŒè´£ï¼š**
- æ ¹æ® method è·¯ç”±åˆ°å¯¹åº” Handler
- Handler æ³¨å†Œå’Œç®¡ç†
- ç»Ÿä¸€é”™è¯¯å¤„ç†

**æ ¸å¿ƒç±»ï¼š**
- `RpcRouter` - è·¯ç”±å™¨
- `RpcHandler` - Handler æ¥å£

#### 4. EventBus äº‹ä»¶æ€»çº¿

**èŒè´£ï¼š**
- äº‹ä»¶å‘å¸ƒ
- äº‹ä»¶è®¢é˜…
- WebSocket æ¨é€

**æ ¸å¿ƒç±»ï¼š**
- `EventBus` - äº‹ä»¶æ€»çº¿
- `AgentEvent` - äº‹ä»¶æ¨¡å‹

#### 5. Session ç®¡ç†

**èŒè´£ï¼š**
- Session åˆ›å»º
- Session çŠ¶æ€ç®¡ç†
- Session åˆ‡æ¢

**æ ¸å¿ƒç±»ï¼š**
- `SessionService` - ä¸šåŠ¡å±‚
- Session çŠ¶æ€æœº

#### 6. Run ç”Ÿå‘½å‘¨æœŸ

**èŒè´£ï¼š**
- Run çŠ¶æ€æµè½¬
- Token ç»Ÿè®¡
- æˆæœ¬è®¡ç®—

**æ ¸å¿ƒç±»ï¼š**
- `RunService` - ä¸šåŠ¡å±‚
- `RunStateMachine` - çŠ¶æ€æœº

#### 7. SessionLane ä¸²è¡Œé˜Ÿåˆ—

**èŒè´£ï¼š**
- å¹¶å‘æ§åˆ¶
- ä»»åŠ¡æ’é˜Ÿ
- é¡ºåºä¿è¯

**æ ¸å¿ƒç±»ï¼š**
- `LaneAwareQueueManager` - é˜Ÿåˆ—ç®¡ç†å™¨

---

## RPC åè®®è¯¦è§£

### ä¸‰å…ƒæ¨¡å‹ï¼šRequest / Response / Event

#### Requestï¼ˆè¯·æ±‚ï¼‰

```json
{
  "type": "request",
  "id": "req-12345",
  "method": "agent.run",
  "params": {
    "sessionId": "session-abc",
    "messages": [
      {"role": "user", "content": "ä»‹ç»ä¸€ä¸‹ OpenClaw"}
    ]
  }
}
```

**å­—æ®µè¯´æ˜ï¼š**
- `type` - å›ºå®šä¸º "request"
- `id` - è¯·æ±‚å”¯ä¸€æ ‡è¯†
- `method` - æ–¹æ³•åï¼ˆå¦‚ï¼šagent.run, session.createï¼‰
- `params` - æ–¹æ³•å‚æ•°

#### Responseï¼ˆå“åº”ï¼‰

```json
{
  "type": "response",
  "id": "req-12345",
  "result": {
    "runId": "run-67890",
    "status": "queued"
  }
}
```

**å­—æ®µè¯´æ˜ï¼š**
- `type` - å›ºå®šä¸º "response"
- `id` - å¯¹åº”çš„è¯·æ±‚ ID
- `result` - å“åº”ç»“æœï¼ˆæˆåŠŸæ—¶ï¼‰
- `error` - é”™è¯¯ä¿¡æ¯ï¼ˆå¤±è´¥æ—¶ï¼‰

#### Eventï¼ˆäº‹ä»¶ï¼‰

```json
{
  "type": "event",
  "event": "run.progress",
  "runId": "run-67890",
  "data": {
    "delta": "OpenClaw",
    "accumulated": "OpenClaw æ˜¯"
  }
}
```

**å­—æ®µè¯´æ˜ï¼š**
- `type` - å›ºå®šä¸º "event"
- `event` - äº‹ä»¶ç±»å‹ï¼ˆå¦‚ï¼šrun.started, run.progress, run.completedï¼‰
- `runId` - å…³è”çš„ Run ID
- `data` - äº‹ä»¶æ•°æ®

### å¸¸è§äº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | æ•°æ® |
|---------|------|------|
| `run.started` | Run å¼€å§‹æ‰§è¡Œ | `{runId, timestamp}` |
| `run.progress` | Run è¿›åº¦æ›´æ–° | `{delta, accumulated}` |
| `run.completed` | Run å®Œæˆ | `{runId, result}` |
| `run.failed` | Run å¤±è´¥ | `{runId, error}` |
| `run.cancelled` | Run è¢«å–æ¶ˆ | `{runId}` |

---

## å®Œæ•´æµç¨‹ç¤ºä¾‹

### ç”¨æˆ·å‘èµ·å¯¹è¯

**1. å»ºç«‹ WebSocket è¿æ¥**

```javascript
const ws = new WebSocket('ws://localhost:8080/ws');
```

**2. å‘é€ RPC è¯·æ±‚**

```javascript
ws.send(JSON.stringify({
  type: 'request',
  id: 'req-123',
  method: 'agent.run',
  params: {
    messages: [{role: 'user', content: 'ä»‹ç»ä¸€ä¸‹ OpenClaw'}]
  }
}));
```

**3. æ¥æ”¶å“åº”**

```javascript
ws.onmessage = (event) => {
  const data = JSON.parse(event.data);

  if (data.type === 'response') {
    console.log('Run created:', data.result.runId);
  } else if (data.type === 'event') {
    if (data.event === 'run.progress') {
      // å®æ—¶æ˜¾ç¤º AI ç”Ÿæˆå†…å®¹
      appendText(data.data.delta);
    } else if (data.event === 'run.completed') {
      console.log('Run completed');
    }
  }
};
```

**4. æœåŠ¡å™¨æ¨é€äº‹ä»¶æµ**

```
â†’ {"type":"response","id":"req-123","result":{"runId":"run-456"}}
â†’ {"type":"event","event":"run.started","runId":"run-456"}
â†’ {"type":"event","event":"run.progress","runId":"run-456","data":{"delta":"OpenClaw"}}
â†’ {"type":"event","event":"run.progress","runId":"run-456","data":{"delta":"æ˜¯"}}
â†’ {"type":"event","event":"run.progress","runId":"run-456","data":{"delta":"ä¸€ä¸ª"}}
â†’ ...
â†’ {"type":"event","event":"run.completed","runId":"run-456"}
```

---

## æœ¬ç« å­¦ä¹ è·¯å¾„

### 5.1 WebSocket å®æ—¶é€šä¿¡
- è¿æ¥å»ºç«‹ä¸ç®¡ç†
- å¿ƒè·³æ£€æµ‹
- æ–­çº¿é‡è¿

### 5.2 RPC åè®®è®¾è®¡
- Request/Response/Event æ ¼å¼
- åè®®è§£æ
- é”™è¯¯å¤„ç†

### 5.3 RPC Router å®ç°
- Handler æ³¨å†Œ
- è·¯ç”±åˆ†å‘
- ç­–ç•¥æ¨¡å¼

### 5.4 EventBus äº‹ä»¶æ€»çº¿
- äº‹ä»¶å‘å¸ƒè®¢é˜…
- WebSocket æ¨é€
- å“åº”å¼å®ç°

### 5.5 Session ç®¡ç†
- Session çŠ¶æ€æœº
- åˆ›å»ºã€åˆ—è¡¨ã€åˆ‡æ¢

### 5.6 Run çŠ¶æ€æœº
- ç”Ÿå‘½å‘¨æœŸç®¡ç†
- çŠ¶æ€æµè½¬æ§åˆ¶

### 5.7 SessionLane ä¸²è¡Œé˜Ÿåˆ—
- å¹¶å‘æ§åˆ¶
- é¡ºåºä¿è¯
- Reactor å®ç°

### 5.8 ä¸»é“¾è·¯ä¸²è”
- å®Œæ•´ä¸šåŠ¡æµç¨‹
- ç«¯åˆ°ç«¯å®ç°

### 5.9 Messages æŒä¹…åŒ–
- å¤šè½®å¯¹è¯å­˜å‚¨
- ä¸Šä¸‹æ–‡ç®¡ç†

---

## æŠ€æœ¯æ ˆ

- **Spring WebFlux** - Reactive Web æ¡†æ¶
- **Reactor** - å“åº”å¼ç¼–ç¨‹åº“
- **WebSocket** - å®æ—¶é€šä¿¡åè®®
- **Jackson** - JSON åºåˆ—åŒ–
- **PostgreSQL** - æ•°æ®æŒä¹…åŒ–

---

## å°ç»“

**æœ¬ç« æ ¸å¿ƒä»·å€¼ï¼š**
- âœ… ç†è§£ä¸ºä»€ä¹ˆ AI Agent éœ€è¦å®æ—¶é€šä¿¡
- âœ… æŒæ¡ WebSocket + RPC æ¶æ„è®¾è®¡
- âœ… å®ç°å®Œæ•´çš„å®æ—¶é€šä¿¡ç³»ç»Ÿ
- âœ… å­¦ä¼šå¹¶å‘æ§åˆ¶å’ŒçŠ¶æ€ç®¡ç†

**å­¦å®Œæœ¬ç« åï¼Œä½ å°†èƒ½å¤Ÿï¼š**
- æ„å»ºå®æ—¶é€šä¿¡ç³»ç»Ÿ
- è®¾è®¡ RPC åè®®
- å®ç°äº‹ä»¶é©±åŠ¨æ¶æ„
- å¤„ç†å¹¶å‘å’ŒçŠ¶æ€ç®¡ç†

---

å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹ 5.1 WebSocket å®æ—¶é€šä¿¡ï¼ğŸš€

[ä¸‹ä¸€èŠ‚ï¼š5.1 WebSocket å®æ—¶é€šä¿¡ â†’](./5.1-websocket-connection.md)
